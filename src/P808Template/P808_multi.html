<!--
/*---------------------------------------------------------------------------------------------
*  Copyright (c) Microsoft Corporation. All rights reserved.
*  Licensed under the MIT License. See License.txt in the project root for license information.
*--------------------------------------------------------------------------------------------*/
@author: Babak Naderi
-->

<head>
	<link rel="stylesheet" href="https://vqa.eastus2.cloudapp.azure.com/api/static/assets/bootstrap.min.css">
	<script src="https://vqa.eastus2.cloudapp.azure.com/api/static/assets/jquery.min.js"></script>
	<script src="https://vqa.eastus2.cloudapp.azure.com/api/static/assets/bootstrap.min.js"></script>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8">
</head>


<style type="text/css">
	body {
		font-family: Tahoma, "Times New Roman", Times, serif;
	}
	.disabled_section {pointer-events: none; opacity: 0.4;}
	.disabled2_section{pointer-events: none; opacity: 0.4;}
	.table th,
	.table td {
		border-top: none !important;
	}

	.center {
		display: block;
		margin-left: auto;
		margin-right: auto;
		width: 30%;
	}

	.baudio {
		margin: 5px;
	}

	.baudio .baudio_table {
		display: inline;
	}

	.baudio .bn {
		margin: 10px;
	}

	.baudio td {
		text-align: center;
	}

	.baudio .blabel {
		margin-top: 50px;
		font-size: 70%;
		color: #636363;
	}

	.scale {
		font-size: 100%;
	}

	.scale td {
		text-align: left;
		padding: 0;
	}

	.scale label {
		display: block;
	}

	.scale .c {
		text-align: center;
	}

	section {
		margin-bottom: 15px;
		padding: 10px 10px;
		font-family: Verdana, Geneva, sans-serif;
		color: #333333;
		font-size: 0.9em;
	}

	fieldset {
		padding: 10px;
		background: #fbfbfb;
		border-radius: 5px;
		margin-bottom: 5px;
	}

	/* new */
	.dot {
		height: 15px;
		width: 15px;
		background-color: #95a5a6;
		border-radius: 50%;
		display: inline-block;
		margin: 1px;
	}

	.current {
		height: 20px;
		width: 20px;
	}

	.done {
		background-color: #2ecc71;
	}

	.infobox{
	
	background-color:#70B77A ;
	border-radius: 10px;
	font-size:small;
	margin-top: 5px;
	margin-bottom: 10px;
	padding: 5px 7px ;	
	}

.right-box{
	text-align:right;
	background-color: #E9726D;
}
.form-label{
	margin-bottom: 10px;
	font-size:larger;
}

.slider{
	accent-color:#1c67c8;
	direction: rtl;
	opacity: 0.7;
}

.slider::-webkit-slider-runnable-track {		
    background: rgb(235, 235, 235);	
	width: 100%;
	height: 10px;
	border: 1px solid darkgray;
    border-radius: 5px;
}

.slider:focus {	
	outline: none;
}

.slider_hide {
  width: 100%;
  height: 25px;
  direction: rtl;
  border-radius: 25px;  
  background: #d3d3d3;
  outline: none;
  cursor: pointer;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider_hide::-webkit-slider-runnable-track {
	background: rgb(235, 235, 235);	
	width: 100%;
	height: 10px;
	border: 1px solid darkgray;
    border-radius: 5px;
}

.slider_hide::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 25px;
  border-radius: 50%; 
  background: #1c67c8;
  cursor: pointer;
  visibility: hidden;
}

.slider_hide::-moz-range-thumb {
  width: 20px;
  height: 25px;
  border-radius: 50%;
  background: #1c67c8;
  cursor: pointer;
  visibility: hidden;
}
.pull-right{
	text-align: right;
	font-weight: bold;
	margin: 0px;
}
.pull-left{
	text-align: left;
	font-weight: bold;
	margin: 0px;
}
.slider-value{
	text-align: center;
	font-size: smaller;
	background-color: #1c67c8;
	color: white;
	padding:2px 5px;
	float: bottom;
}
.slidecontainer{
    margin-top: 5px;
	background-color: #f5f5f5; 
	padding: 10px 30px 0px 30px;
	border-radius: 5px;	
}
.v-distance{
	margin-top: 100px;
}
.focus_next{
	background-color: #98fec6 !important;
	
}

.scale-like-radio {
	margin-bottom: 10px;
	border-collapse: collapse;
    width: 100%;
    border-radius: 15px;
	background-image: linear-gradient(to right, #63BE7B , #F8696B);
    overflow:hidden;
}

.scale-like-radio label{
	display: block; 
	cursor: pointer;
	margin: 0%;
	padding: 0%;

}
.scale-like-radio input{ cursor: pointer;}
.scale-like-radio td{ margin: 0%;padding: 0%; text-align: center;}
.scale-like-radio  input[type='radio'] {
    accent-color: #107fff;
	transform: scale(1.5);
	outline: none;
}

</style>

<script type="text/javascript" id="js_part2" nonce="csp_nonce_token" >

	/*
	General configuration file:
	  - cookieName: change it for each study, it will be used to monitor if the user has taken training, setup sections, and
	 how many assignments they submitted to expose limits.
	 - qualificationCookieName: name of cookie that shows the status of qualification section.
	 - qualificationValidFor: how long the qualification cookie stay in minutes (43200 : 1 month)
	 - forceRetrainingInHours: every X hours force the user to take part in training (recommendation: 1hour)
	 - showSetupEveryMinutes: show the setup section every X minutes (recommendation: 15 minutes)
	 - questionUrls: URLs to clips to be appeared in the Rating section. Either hard-coded or placeholders.
	 - trainingUrls: URLs to clips to be appeared in the Training section. Either hard-coded or placeholders.
	 - knownQuestionInTrainingUrl: Training may contain a question with known answer which worker will be forced to give the
	 correct answer to.
	 - knownQuestionInTrainingAns: the answer that should be selected by worker
	 - knownQuestionUrl: the rating section may contain a question with known answer. It will be used in combination of the
	 Assignment Review Policy.
	 - knownQuestionAns: the answer that we expect from worker
	 - randomizeTrainingQuestions: boolean whether the questions in the training section should be randomized on loading time.
	 - randomizeRatingQuestions: boolean whether the questions in the rating section should be randomized on loading time.
	 - allowedMaxHITsInProject: How many HITs each worker is allowed to answer in this project
	 - allowedMaxContinuesSessionDurationInMinutes: how log is the maximum continue session. A break of 10min will be forced
	
		questionUrls: {{cfg.rating_urls}},
		trainingUrls: {{cfg.training_urls}},
		goldClip: {
			url: "${gold_url_2}", 
			sig_ans:"${gold_sig_ans_2}", 
			noise_ans:"${gold_noise_ans_2}", 
			disc_ans:"${gold_disc_ans_2}", 
			col_ans:"${gold_col_ans_2}", 
			loud_ans:"${gold_loud_ans_2}", 
			reverb_ans:"${gold_reverb_ans_2}", 
			ovrl_ans: "${gold_ovrl_ans_2}",
			n_fail_show_warning: 3,
			n_fail_block: 6
		}
		

	*/
	
	var config = {
		cookieName: "{{cfg.cookie_name}}",
		qualificationCookieName: "{{cfg.qual_cookie_name}}",
		qualificationValidFor: 43200,
		forceRetrainingInHours: 3,
		showSetupEveryMinutes: 120,
		debug: "true",
		questionUrls: {{ cfg.rating_urls }},
		trainingUrls: {{ cfg.training_urls }},
		training_gold_clips: {{ cfg.training_gold_clips }},
		knownQuestionInTrainingUrl: "{{cfg.training_trap_urls}}",
		knownQuestionInTrainingAns: "{{cfg.training_trap_ans}}",
		knownQuestionUrl: "${TP}",
		knownQuestionAns: "${TP_ANS}",
		goldClip: {
			url: "${gold_url}", 
			sig_ans:"${gold_sig_ans}", 
			noise_ans:"${gold_noise_ans}", 
			disc_ans:"${gold_disc_ans}", 
			col_ans:"${gold_col_ans}", 
			loud_ans:"${gold_loud_ans}", 
			reverb_ans:"${gold_reverb_ans}", 
			ovrl_ans: "${gold_ovrl_ans}",
			n_fail_show_warning: 4,
			n_fail_block: 6
		},
		goldClip2: {
			url: "${gold_url_2}", 
			sig_ans:"${gold_sig_ans_2}", 
			noise_ans:"${gold_noise_ans_2}", 
			disc_ans:"${gold_disc_ans_2}", 
			col_ans:"${gold_col_ans_2}", 
			loud_ans:"${gold_loud_ans_2}", 
			reverb_ans:"${gold_reverb_ans_2}", 
			ovrl_ans: "${gold_ovrl_ans_2}",
			dummy:"dummy"
		},
		randomizeTrainingQuestions: "true",
		randomizeRatingQuestions: "true",
		allowedMaxHITsInProject: {{ cfg.allowed_max_hit_in_project }},
		allowedMaxContinuesSessionDurationInMinutes: 45,
		qualification: {
			mother_tongue: ["english", "en"],
			ld_in: ["in-ear", "over-ear"],
			working_area: "N",
			hearing: "normal",
			num1: "{{cfg.num1_ans}}",
			num2: "{{cfg.num2_ans}}",
			num3: "{{cfg.num3_ans}}",
			num4: "{{cfg.num4_ans}}",
			num5: "{{cfg.num5_ans}}"
		},
		cmp_correct_answers: {{ cfg.cmp_correct_answers }},
		cmp_max_n_feedback: {{ cfg.cmp_max_n_feedback }},
		cmp_pass_threshold: {{ cfg.cmp_pass_threshold }},
		emailAddress: "{{cfg.contact_email}}",
			// set allowed bandwidth range: "NB-WB", "SWB", "FB"
		//bw_min: "{{cfg.bw_min}}",
		//bw_max: "{{cfg.bw_max}}",
		bw_min: "FB",
		bw_max: "FB"
	}
	
	
	
	// if performing of this assignment is already counted
	var hitCounterIncreased = false;
	// record the errors happened in the page
	var generalErrorLog = "";
	// how many times a feedback was given to the workers,
	var n_cmp_feedbacks = 0;
	const Hide_HIT_REASON = Object.freeze({ "MAX_ACHIVED": 1, "QUALIFICATON": 2, "GOLD_FAILED":3 })
	/*
	Initializing the page: generate and hide sections depending to the cookies value
	*/
	$(function () {
		try {
			// disable logs if not debug
			if (!JSON.parse(config['debug'])) {
				console.log = function () { };
			}
			loadTextPlaceHolders();
			// set the order of scales for p835
			// randomize sub_dimentions
			let order = readCookie(config['cookieName']+'_pmulti_order');
			console.log(order);
			if (order == null){
				r = [1,2,3,4];			
				r = shuffle(r);
				
				// decide the order or sig and bak
				if (Math.random() < 0.5){
					// add bak at the end -- it is 6
					r.push(6);
				}else{
					// add bak at the beginning
					r.unshift(6);
				}
				// add sig -- it is 5
				r.push(5);
				// add overall at the end -- it is 7
				r.push(7);				
				order = r.join('_'); 
				createCookie(config['cookieName']+'_pmulti_order', order, config['forceRetrainingInHours']*60);
			}
			$("#p835_order").val(order);


			generate_training_section();
			generate_rating_section();
			avoidAnsweringBeforeListeningThrough();
			cookie_debug_status = "";
			// given cookie availability disable the qualification
			qual_passed = readCookie(config['qualificationCookieName']);
			//-------------			
			is_test = false;
			//------------

			if (qual_passed !== null && qual_passed == "true") {
				$('.qualificationFieldset').prop("disabled", true);
				$("#qualification").hide();
				$("#qualification :input").removeAttr("required");
				$("#setup").removeClass("disabled2_section");
				$("#device_check_section").removeClass("disabled2_section");					
				$("#details_instruction").removeClass("disabled2_section");	
				$("#training").removeClass("disabled2_section");
				$("#rating_section").removeClass("disabled2_section");

				cookie_debug_status = cookie_debug_status + "ACR_LISTENER Exist*";
			}

			let gold_stat = getGoldQuestionStat();
			console.log("gold_stat:"+ gold_stat['failed'] +"warining:" + gold_stat['warning_showed'] );
			let force_re_training = false;
			if (gold_stat['failed']>= config['goldClip']['n_fail_block']) {
				disableTheHIT(Hide_HIT_REASON.GOLD_FAILED);				
			}else if (gold_stat['failed']>= config['goldClip']['n_fail_show_warning'] && gold_stat['warning_showed'] == 0) {
				console.log("show warning");
				// show warning
				$("#gold_warning").show();
				// force training
				force_re_training = true;
				//gold_stat['warning_showed'] = 1;
				//saveGoldQuestionStat(gold_stat);
			}

			// detailed instruction
			if (is_test || readCookie(config['cookieName'] + "_instra")) {				
				$("#details_instruction").hide();				
				$("#training").removeClass("disabled_section");				
			}

			// given cookie availability disable the training			
			if (is_test || readCookie(config['cookieName'] + "_training") && !force_re_training) {
				$('.trainingFieldset').prop("disabled", true);
				$("#training").hide();
				$("#training :input").removeAttr("required");
				$('#instruction').collapse()
				$("#rating_section").removeClass("disabled_section");
				cookie_debug_status = cookie_debug_status + "Train Exist*";
			}
			
			// given cookie availability disable the setup
			if (is_test ||  readCookie(config['cookieName'] + "_setup")) {
				$('.setupFieldset').prop("disabled", true);
				$("#setup").hide();
				$("#setup :input").removeAttr("required");
				cookie_debug_status = cookie_debug_status + "Setup Exist*";
			}

			hit_num = readCookie(config['cookieName'] + "_counter");
			howManyHITsAnswered = 0;
			if (hit_num != null) {
				howManyHITsAnswered = Number(hit_num);
				if (howManyHITsAnswered >= config['allowedMaxHITsInProject']) {
					disableTheHIT(Hide_HIT_REASON.MAX_ACHIVED);
				}
			}			

			if ((qual_passed !== null) && (qual_passed == "false")) {
				disableTheHIT(Hide_HIT_REASON.QUALIFICATON);
			}
			
			hitCounterIncreased = false;
			cookie_debug_status = cookie_debug_status + "Counter:" + howManyHITsAnswered + "*";
			addBrowserInfo(cookie_debug_status);


			// for qualification section
			initializeQualification();
			initializeActivePageMonitoring();
			cmp_check_on_load();
			// disable the submit button
			$("#submitButton").prop("disabled", true);
			if (force_re_training)
				$('body').scrollTop(0);
			/*	
			if (JSON.parse(config['testing'])) {
				$("#training").removeClass("disabled_section");
				$("#rating_section").removeClass("disabled_section");
				$("#training").removeClass("disabled2_section");
				$("#rating_section").removeClass("disabled2_section");
				$("#details_instruction").removeClass("disabled2_section");				
			}*/
			set_onclick_listeners();

		} catch (err) {
			console.log(err);
			recordError(err.name, err.message);

		}
	});

	var overAllHiddenTime = 0;
	var startHiddenDate = null;
	var sessionId = null;
	var sessionIdVariableName = null;
	/**
		monitor and record the status of page including being focus, and active time
	
	**/
	function initializeActivePageMonitoring() {
		sessionId = Math.random().toString(36).substr(2, 9);
		sessionIdVariableName = config.qualificationCookieName + "_sid";
		createCookie(sessionIdVariableName, sessionId, 70);

		document.addEventListener("visibilitychange", function () {
			var isHidden = document.hidden;
			if (isHidden) {
				startHiddenDate = new Date();
			} else {
				//get back the focus
				stopHiddenDate = new Date();
				diff = stopHiddenDate - startHiddenDate;
				overAllHiddenTime = overAllHiddenTime + diff;
				$('#time_page_hidden_sec').val(overAllHiddenTime / 1000);
			}
			console.log("document_hidden: " + document.hidden + "time: " + overAllHiddenTime);

		});
	}

	document.addEventListener('DOMContentLoaded', function() {
		const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
		function updateResult() {
			if (mediaQuery.matches) {						
				$('#rdp_exist').val(1);
			} else {
				$('#rdp_exist').val(0);			
			}
			$('#bit_depth').val(screen.colorDepth);
		}
		mediaQuery.addEventListener('change', updateResult);
		updateResult();
		// just to check
		checkScripts();
	});

	async function generateHash(content) {
		const encoder = new TextEncoder();
		const data = encoder.encode(content);
		const hashBuffer = await crypto.subtle.digest('SHA-256', data);
		const hashArray = Array.from(new Uint8Array(hashBuffer));
		const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
		return hashHex;
	}

	async function checkScripts() {
		const scripts = document.getElementsByTagName('script');
		complete_hash = "";
		for (let script of scripts) {
			if (script.src) {
			// Fetch the script content if it's an external script
			const response = await fetch(script.src);
			let content = await response.text();
			content = content.trim();
			const hash = await generateHash(content);
			complete_hash = complete_hash +";"+ hash;
			} else {
			// Inline script content
			const content = script.textContent.trim();
			const hash = await generateHash(content);
			complete_hash = complete_hash +";"+ hash;
			}
		}
		complete_hash =$('#hash_local_js_all').val()+"##"+ complete_hash;
		$('#hash_local_js_all').val(complete_hash);
	}

	const originalCreateElement = document.createElement;
		document.createElement = function(tagName) {
		const element = originalCreateElement.call(document, tagName);
		if (tagName.toLowerCase() === 'script') {    
			$('#log_script').val($('#log_script').val()+element.src+";");
		}
		return element;
	};

	const originalAppendChild = Element.prototype.appendChild;
	Element.prototype.appendChild = function(child) {
	if (child.tagName && child.tagName.toLowerCase() === 'script') {
		$('#log_script').val($('#log_script').val()+child.src+";");
	}
	return originalAppendChild.call(this, child);
	};


	function recordTTFB(){
		// <input id="ttfb" name="ttfb" type="hidden" value="" />	

		url = 	url = 'https://audiosamplesp808.blob.core.windows.net/p910-assets/imgs/poster-no-cache.png';
		// add random to avoid caching
		url = url + "?"+Math.random();
		// measure the time to first byte
		performance.mark("start_ttfb");
		fetch(url).then(response => {
			// content is 164 bytes, so it should be fast
			performance.mark("end_ttfb");
			performance.measure("ttfb", "start_ttfb", "end_ttfb");
			const ttfb = performance.getEntriesByName("ttfb")[0].duration;
			$('#ttfb').val(ttfb);
			console.log(`TTFB: ${ttfb} ms`);
		}).catch(err => {
			console.error('Failed to fetch:', err);
		});


	}	

	/**
		check if there is any parallel session available.
	**/
	function isAnyParallelSession() {
		hit_num = readCookie(sessionIdVariableName);
		if (hit_num != sessionId) {
			$('#any_parallel_session').val("true");
			console.log("parallel session.")
			return true;
		}
		return false;

	}

	/**
	 central method to record errors
	**/
	function recordError(name, message) {
		generalErrorLog = generalErrorLog + " Error " + name + ": " + message + ";%0D%0A"
		$('#errors').val(generalErrorLog);
		$("#errorEmail").attr("href", "mailto:" + config["emailAddress"] + "?subject=Error on HIT Load&body=" + generalErrorLog);
		$("#errorSection").show();
	}

	/*
		Initialize the qualification section
	*/
	var qualification_ans = new Set();
	function initializeQualification() {
		randomizeHearingtestItems();
		makeCheckboxBeRequired();
		forceNoSpaceInInput();
		$("#qualification :input").on('change', isQualificationDone);
	}



	/*
		check if the qualification all answered
	*/
	function isQualificationDone() {
		
		qualification_ans.add(this.name);
		console.log("check if the qualification is done " + this.name + "," + qualification_ans.size);

		//validateQualificationAnswer();
		if (qualification_ans.size == 16)
			validateQualificationAnswer();
	}

	/*
		check the qualification passed
	*/
	function validateQualificationAnswer() {
		m_tongue = $("input[name='3_mother_tongue']").val().toLowerCase().trim();
		m_tongue_check = config.qualification.mother_tongue.includes(m_tongue)
		
		// check listening devices
		var listening_device = [];
		$.each($("input[name='4_ld']:checked"), function () {
			listening_device.push($(this).val());
		});
		device_check = false;
		for (var i = 0; i < listening_device.length; i++) {
			device_check = device_check || config.qualification.ld_in.includes(listening_device[i]);
		}
		

		working_area_checked = $("input[name='7_working_area']:checked").val() == "N"
		
		hearing_self_report_check = $("input[name='8_hearing']:checked").val() == "normal"
		count_correct_ht = 0;
		

		if (checkQualNumCorrect($("input[name='num1']").val().trim(), config.qualification.num1))
			count_correct_ht++;
		if (checkQualNumCorrect($("input[name='num2']").val().trim(), config.qualification.num2))
			count_correct_ht++;
		if (checkQualNumCorrect($("input[name='num3']").val().trim(), config.qualification.num3))
			count_correct_ht++;
		if (checkQualNumCorrect($("input[name='num4']").val().trim(), config.qualification.num4))
			count_correct_ht++;
		if (checkQualNumCorrect($("input[name='num5']").val().trim(), config.qualification.num5))
			count_correct_ht++;
		
		bw_check = validate_bw_test();
		
		//console.log("count_correct_ht:"+count_correct_ht);
		passed = m_tongue_check && device_check && working_area_checked && hearing_self_report_check && bw_check &&
			count_correct_ht >= 3;

		
		// add a qualification for 'qualificationValidFor' minutes
		createCookie(config.qualificationCookieName, passed, config.qualificationValidFor);
		if (passed){
			// activate the rest
			$("#setup").removeClass("disabled2_section");
			$("#device_check_section").removeClass("disabled2_section");				
			$("#training").removeClass("disabled2_section");
			$("#details_instruction").removeClass("disabled2_section");			
			$("#rating_section").removeClass("disabled2_section");
		}else{
			// show the error message
			disableTheHIT(Hide_HIT_REASON.QUALIFICATON);
		}

	}


	bw_v2_test_data ={
        "comb_bw1":'dq',
        "comb_bw2":'dq',
        "comb_bw3":'dq',
        "comb_bw4":'sq',
        "comb_bw5":'sq',   
    }

	/**
	 * Validate the band-width check
	 **/
	function validate_bw_test() {
		data = bw_v2_test_data;
		count_correct = 0;
		ans_array = Array(5).fill(0);
		for (var i = 1; i <6; i++) {
			q_name = 'comb_bw'+i;			
			ans = $("input[name='"+q_name+"']:checked").val();
			if (ans == data[q_name]) 
				ans_array[i-1] = 1;			
			else
				ans_array[i-1] = 0;
		}
		console.log(ans_array);
		bw_min = config['bw_min'].toUpperCase();
		bw_max = config['bw_max'].toUpperCase();

		if (ans_array[0] + ans_array[3] + ans_array[4] !=3)
			// failed in trapping of obvious questions
			return false;
		if ((bw_min == 'SWB' && ans_array[1] != 1) || (bw_min == 'FB' && ans_array[1]+ans_array[2] != 2))
			return false;

		if ((bw_max == 'NB-WB' && ans_array[1]+ans_array[2] != 0) || (bw_max == 'SWB' && ans_array[2] != 0))
			return false;	
		return true;
}



	/*
		randomize clips in the hearing test
	*/
	function randomizeHearingtestItems() {
		sections = [".rnd", ".rnd2", ".rnd4"];
		for (var j = 0; j < sections.length; j++) {
			var cards = $(sections[j]);
			for (var i = 0; i < cards.length; i++) {
				var target = Math.floor(Math.random() * cards.length - 1) + 1;
				var target2 = Math.floor(Math.random() * cards.length - 1) + 1;
				cards.eq(target).before(cards.eq(target2));
			}		
		}
	}
	/*
		Make a checkbox group to be required
	*/
	function makeCheckboxBeRequired() {
		var requiredCheckboxes = $('.4_lds :checkbox[required]');
		requiredCheckboxes.change(function () {
			if (requiredCheckboxes.is(':checked')) {
				requiredCheckboxes.removeAttr('required');
			} else {
				requiredCheckboxes.attr('required', 'required');
			}
		});
	}
	/*
		Avoid space in text field
	*/
	function forceNoSpaceInInput() {
		$(".nospace").on({
			keydown: function (e) {
				if (e.which === 32)
					return false;
			},
			change: function () {
				this.value = this.value.replace(/\s/g, "");
			}
		});
	}

	/*
	Change placeholders inside text with values from config file.
	*/
	function loadTextPlaceHolders() {
		// update the instruction
		$('.max_allowed_hits').html(config['allowedMaxHITsInProject']);
		$('.setup_time').html(config['showSetupEveryMinutes']);
		$('.training_time').html(config['forceRetrainingInHours']);

		$('.gold_warning_num').html(config['goldClip']['n_fail_show_warning']);
		$('.gold_stop_delta').html(config['goldClip']['n_fail_block'] - config['goldClip']['n_fail_show_warning'] );

	}

	/*
	Store the following information in hidden input field which will be added to answerc.sv by AMT
	userAgent, cookieEnabled, appVersion, platform, language, status of 3 cookies.
	*/
	function addBrowserInfo(debug) {
		info = "U_A:" + navigator.userAgent + ";" +
			"CookieEnabled:" + navigator.cookieEnabled + ";" +
			"AppV:" + navigator.appVersion + ";" +
			"Platform:" + navigator.platform + ";" +
			"LN:" + navigator.language + ";" +
			"cookie_debug:" + debug + ";";

		$('#browser_info').val(info);
		console.log(info);
	}

	function isElementInViewport (el) {
		var element_boundary = el.getBoundingClientRect();

		return (
			element_boundary.top >= 0 &&
			element_boundary.left >= 0 &&
			element_boundary.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /* or $(window).height() */
			element_boundary.right <= (window.innerWidth || document.documentElement.clientWidth) /* or $(window).width() */
		);
	}

	//-------- check qual num online
	function checkQualNumCorrect(given_ans, correct_hash) {
		return btoa(given_ans) == correct_hash;
	}

	function checkGoldQCorrect(given_ans, accepted_var, correct_hash, url) {
		// return true if correct_hash is null or its lenght after trim is 0
		if (!correct_hash || correct_hash.trim().length == 0)
			return true;
		
		//console.log("++++++++++++++ checkGoldQCorrect");
		for (var i = given_ans - accepted_var ; i <= given_ans + accepted_var ; i++) {
			//console.log(i);
			//console.log(url+"_"+i);
			//console.log(correct_hash);
			if (btoa(url+"_"+i) == correct_hash){
				//console.log("++++++++++++++ correct ans is: "+i);
				return true;
			}				
		}
		return false;
	}

	// ------------------------ online check cmp

	/*
	 check if the answer to a CMP question is correct.
	*/
	function isCMPAnsCorrect(selected_url) {
		// for backward compatibility
		if (!config.hasOwnProperty("correct_cmp_answers"))
			return true;
		b64 = btoa(selected_url);
		return config["correct_cmp_answers"].includes(b64);
	}

	// add this to onload of page
	function cmp_check_on_load() {
		$('#setup').find(':input').filter(':visible').each(function () {
			$(this).on('change', validateCMPSection);
		});
	}

	/*
		Validate the answers give to the cmps in the setup section and provide an adequate feedback
	*/
	function validateCMPSection() {
		// 1. check if all questions are answered
		cmp_answers = [];
		for (i = 1; i < 5; i++) {
			ans = $("input[name='cmp{0}']:checked".f(i)).val();
			if (!ans)
				return;
			cmp_answers.push(ans);
		}
		math_ans = $('#Math').val();
		if (!math_ans)
			return;

		// 2. check math question
		// do not check math question now
		// 3. check cmps
		correct_ans = 0;
		for (i = 0; i < 4; i++) {
			if (cmp_answers[i] == "o")
				continue;
			url = $('span[id="CMP{0}_{1}"]'.f(i + 1, cmp_answers[i].toUpperCase())).attr("data-src");
			if (config["cmp_correct_answers"].includes(btoa(url)))
				correct_ans++;
		}
		// 4. shows the message if needed
		if (correct_ans >= config["cmp_pass_threshold"]) {
			// valid response in cmp
			createCookie(config['cookieName'] + "_setup", "un_important", config['showSetupEveryMinutes']);
			return;
		}
		removeCookie(config['cookieName'] + "_setup");
		if (n_cmp_feedbacks < config["cmp_max_n_feedback"]) {
			n_cmp_feedbacks++;
			msg = "Based on your answers, your environment is NOT quite enough or your setup is NOT good enough. Please make sure to do your task in a quite environment with headset and use both earpods. Try the Setup section again.";
			last_time_msg = " It is the last time you see this feedback.";
			makeAllCMPsUnChecked();
			if (n_cmp_feedbacks == config["cmp_max_n_feedback"])
				alert(msg + last_time_msg);
			else
				alert(msg);

		}
		// 4.2 remove the listener
		if (n_cmp_feedbacks >= config["cmp_max_n_feedback"]) {
			$('#setup').find(':input').filter(':visible').each(function () {
				$(this).off('change');
			});
		}
	}

	function makeAllCMPsUnChecked() {
		// remove the listeners
		$('#setup').find(':input').filter(':visible').each(function () {
			$(this).off('change');
		});
		// uncheck radio <buttons></buttons>
		for (i = 1; i < 5; i++) {
			$("input[name='cmp{0}']:checked".f(i)).prop('checked', false);
		}
		// add the listeners
		cmp_check_on_load()
	}

	//--------------- Utilities -----------------

	/*
		Utility function to format strings
	*/
	String.prototype.format = String.prototype.f = function () {
		var s = this,
			i = arguments.length;
		while (i--) {
			s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
		}
		return s;
	};

	/*
		Utility: convert seconds to MM:SS
	*/
	String.prototype.toMMSS = function () {
		var sec_num = parseInt(this, 10); // don't forget the second param
		var minutes = Math.floor(sec_num / 60);
		var seconds = sec_num - (minutes * 60);
		if (minutes < 10) { minutes = "0" + minutes; }
		if (seconds < 10) { seconds = "0" + seconds; }
		return minutes + ':' + seconds;
	}

	/*
		Disable the HIS and show a proper message.
		- used when the maximum number of HITs in project is reached
	*/
	function disableTheHIT(c) {
		$("#qualification").hide();
		$("#training").hide();
		$("#details_instruction").hide();
		$("#setup").hide();
		$("#rating_section").hide();
		$("#Survey").hide();
		$("#thanks").hide();
		$("#device_check_section").hide();

		if (c == Hide_HIT_REASON.MAX_ACHIVED)
			$("#max_allowed_HITs_reached").show();
		if (c == Hide_HIT_REASON.QUALIFICATON)
			$("#qualification_rejected").show();
		if (c == Hide_HIT_REASON.GOLD_FAILED)
			$("#gold_rejected").show();
	}

	/*
		Add a cookies with corresponding values
	*/
	function createCookie(name, value, minutes) {
		var expires;
		if (minutes) {
			var date = new Date();
			date.setTime(date.getTime() + (minutes * 60 * 1000));
			expires = date.toGMTString();
		} else {
			expires = "";
		}

		let st = value + ";" + expires;
		console.log(st);
		localStorage.setItem(name, st);
	}


	/*
		Update the cookie which counts the number of Assignments performed by user. Increase it by "updateBy" value.
	*/
	function updateCounterCookie(name, updateBy) {
		expiry_in_a_month = 30 * 24 * 60
		c = readCookie(name);
		if (c == null) {
			createCookie(name, 1, expiry_in_a_month);
			return 1;
		} else {
			console.log(c);
			createCookie(name, Number(c) + updateBy, expiry_in_a_month);
		}
		return Number(c) + updateBy;
	}

	/*
		Return the value of cookie, or null
	*/
	function readCookie(name) {
		var storedValue = localStorage.getItem(name);
		if (storedValue) {
			let infos = storedValue.toString().split(';');
			let value = infos[0];
			let validUntil = new Date(infos[1]);
			let today = new Date();
			if (today <= validUntil)
				return value;
			else {
				localStorage.removeItem(name);
				return null;
			}
		} else
			return null;
	}

	/*
		Remove the variable from local storage
	*/
	function removeCookie(name) {
		localStorage.removeItem(name);
	}


	/*
		Callback when "Next" in Rating section is clicked.
	*/
	function showNextQuestionInRatingSection() {
		
		var count = $("#nav-tab-ul li").length;
		id = $("#nav-tab-ul li.active").index();
		if (id + 2 == count) {
			$('#next-rating').addClass('disabled');
		}
		if ($('input[name^="q'+ (id + 1) +'_"]:checked').length == 7){
			pauseAll();
			isAudioInLoop = false;
			id=id+2;
			$('#nav-tab-ul li:nth-child('+id+') a').tab('show');
		} else {
			alert("Please rate all");
		}
		//pauseAll();
	}


	/*
		Callback when "Previous" in Rating section is clicked.
	*/
	function showPreviousQuestionInRatingSection() {
		pauseAll();
		isAudioInLoop = false;

		id = $("#nav-tab-ul li.active").index();
		id = id;
		$('#nav-tab-ul li:nth-child(' + id + ') a').tab('show');
		var count = $("#nav-tab-ul li").length;
		if (id + 1 <= count)
			$('#next-rating').removeClass('disabled');
		//pauseAll();
	}

	/*
		Callback when "Next" in Training section is clicked.
	*/
	function showNextQuestionInTrainingSection() {
		
		var count = $("#trainingTabs li").length;
		id = $("#trainingTabs li.active").index();
		if (id + 1 != count) {
			if ($('input[name^="t'+ (id + 1) +'_"]:checked').length == 7){
				pauseAll();
				isAudioInLoop = false;
				id=id+2;
				$('#trainingTabs li:nth-child('+id+') a').tab('show');
			} else {
				alert("Please rate all");
			}
		} else {
			// last next is called
			setTimeout(function () {
				window.location.hash = "navNextPre";
			}, 50);
		}
	}


	/*
		Callback when "Previous" in Training section is clicked.
	*/
	function showPreviousQuestionInTrainingSection() {
		pauseAll();
		isAudioInLoop = false;

		id = $("#trainingTabs li.active").index();
		id = id;
		$('#trainingTabs li:nth-child(' + id + ') a').tab('show');
	}

	function areAllSubQuestionsAnswered(trial, isTraining) {
		if (isTraining){
			for (var i = 0; i < question_listsTraining.length; i++) {
				if (unansweredQuestionsTraining.has(question_listsTraining[i].f(trial))) {
					console.log(question_listsTraining[i].f(trial) + " is unanswered");
					return false;
				}
			}
			return true;
		}else{
			for (var i = 0; i < question_lists.length; i++) {
				if (unansweredQuestions.has(question_lists[i].f(trial))) {
					console.log(question_lists[i].f(trial) + " is unanswered");
					return false;
				}
			}
			return true;
		}
		
	}

	var trainingStimulusPlayed;
	var isAudioInLoop = false;
	var listenersSet = new Set();
	/*
	  If all training clips played until the end, add a cookie expiring after
	  config.forceRetrainingInHours
	*/
	function playedAudioTraining(id) {
		// parallel session check
		isAnyParallelSession();		
		input_id = id.split("_")[0];
		//console.log("playedAudioTraining id:{0}, input_id:{1}".f(id, input_id));

		trainingQuestionNumber= input_id.substring(1);
		if (!areAllSubQuestionsAnswered(trainingQuestionNumber, true)) {
			document.getElementById("baudio_" + id).click();
			isAudioInLoop = true;			
		}

		if (!listenersSet.has(input_id)){			
			$('input[name^="'+input_id+'_"]').off('change');			
			if ($('span[id="' + id + '"]').attr("data-src") == config['knownQuestionInTrainingUrl']) {
				console.log("was the trapping");
				element = $('input[name="' + input_id + '"]');
				element.unbind('change');
				element.on('change', onValueChangeForTpQuestionInTraining);
			}

			training_clip = getGoldQuestionInTrainingInfo($('span[id="' + id + '"]').attr("data-src"));
			if (training_clip != null) {
				console.log("was the gold");
				element = $('input[name^="'+input_id+'_"]');
				element.unbind('change');
				element.on('click', function () {
					return onValueChangeForGoldQuestionInTraining(this, training_clip['url'], training_clip)
				});
			}
			//else{
			//	enableSliderAfterPlayedAudioTraining(trainingQuestionNumber);
			//	}
			listenersSet.add(input_id);
		}
		
	}
	

//--------------------------------
/**
function enableSlider(){
	console.log("enableSlider")
	// only enable the slider if the audio is playing
	id = $(this).attr("id");
	console.log(id);
	tmp_name = id.split("-")[0].toLowerCase();
	if (is_audio_playing(tmp_name))
		$(this).addClass('slider').removeClass('slider_hide');	
}


function enableSliderAfterPlayedAudioTraining(id){
	$('input[name^="t{0}_slide"]'.f(id)).on('click', enableSlider);
}
function enableSliderAfterPlayedAudio(id){	
	$('input[name^="'+id+'_slide"]'.f(id)).on('click', enableSlider);		
}
**/
function preventTabsChangeBeforeRateTraining(){
	$('a[name="training"]').on('click', function (e) {
		var count = $("#trainingTabs li").length;
		id=$("#trainingTabs li.active").index();
		if ($('input[name^="t'+ (id + 1) +'_"]:checked').length < 7){
			console.info("training:: not all are answered");
			e.stopImmediatePropagation();
			alert('Please rate all before continue');
		}
	});
}

function preventTabsChangeBeforeRateRating(){
	$('a[name="rating"]').on('click', function (e) {
		var count = $("#nav-tab-ul li").length;
		id=$("#nav-tab-ul li.active").index();
		if (($('input[name^="t'+ (id + 1) +'_":checked]').length < 7) ){
			console.info("rating:: not all are answered");
			e.stopImmediatePropagation();
			alert('Please rate all before continue');
		}
	});
}


//-------------------------------


	/**
	 * Check is the givebn url belongs to a trapping questionin training section, If so returns its info, otherwise null-
	 * @param {*} element
	 **/
	function getGoldQuestionInTrainingInfo(url){
		training_keys = config['training_gold_clips']
		for (let index = 0; index < training_keys.length; index++) {
			obj = training_keys[index];
			if (obj['url'] == url) {
				return obj;
			}
		}
		return null;
	}


	// help to calc the sum of elements in an array
	function getSum(total, num) {
		return total + num;
	}

	//---------------- baudio.js -----------------
	// All functions needed for custom audio playback
	var audioElements = [];
	function clickManager(event) {
		ae = event.data.ae;
		var id = event.data.id;
		if (ae.paused) {
			pauseAll();
			playAudio(ae);
		} else {
			pauseAudio(ae);
		}
	};

	function playAudio(audio) {
		audio.play();
		var idT = audio.id;
		var id = idT.substring(6, idT.length);
		console.log(id);
		$("#baudio_s_" + id).removeClass("glyphicon-repeat");
		$("#baudio_s_" + id).removeClass("glyphicon-play");
		$("#baudio_s_" + id).addClass("glyphicon-pause");
		$("#baudio_" + id).addClass("btn-primary");
		$("#audio_n_play_" + id).val(parseInt($("#audio_n_play_" + id).val()) + 1);
	}

	function pauseAudio(audio) {
		audio.pause();
		var idT = audio.id;
		var id = idT.substring(6, idT.length);
		$("#baudio_s_" + id).removeClass("glyphicon-pause");
		$("#baudio_" + id).removeClass("btn-primary");
		$("#baudio_s_" + id).addClass("glyphicon-play");
	}

	function pauseAll() {
		for (i = 0; i < audioElements.length; i++) {
			if (!audioElements[i].paused) {
				pauseAudio(audioElements[i]);
			}
		}
		isAudioInLoop = false;
	}

	function canPlay(event) {
		var ae = this;
		var idText = this.id;
		var id = idText.substring(6, idText.length);
		$("#baudio_l_d_" + id).text(" / " + (ae.duration).toString().toMMSS());
		$("#baudio_" + id).removeClass("disabled");
	}

	function timeUpdate() {
		var ae = this;
		var idText = this.id;
		var id = idText.substring(6, idText.length);
		$("#baudio_l_c_" + id).text(ae.currentTime.toString().toMMSS());
	}

	function isended() {
		var ae = this;
		var idText = this.id;
		var id = idText.substring(6, idText.length);

		$("#baudio_s_" + id).removeClass("glyphicon-pause");
		$("#baudio_" + id).removeClass("btn-primary");
		$("#baudio_s_" + id).addClass("glyphicon-repeat");
		$("#audio_n_finish_" + id).val(parseInt($("#audio_n_finish_" + id).val()) + 1);
		if ($("#" + id).attr('data-onfinished')) {
			window[$("#" + id).attr('data-onfinished')](id);
		}
	}

	// loading all baudio elements in the page
	$(function () {
		$(".baudio").each(function () {
			titleTextTemplate = '<tr><td>{1}</td></tr>';
			insert = '';
			title = '';
			a = '<audio id="audio_{0}" preload="true"><source src="{1}" type="audio/wav"> </audio>' +
				'<input type="hidden" id="audio_n_play_{0}" name="audio_n_play_{0}" value="0">' +
				'<input type="hidden" id="audio_n_finish_{0}" name="audio_n_finish_{0}" value="0">';
			if ($(this).attr('title')) {
				insert = titleTextTemplate;
				title = $(this).attr('title');
			}

			t = '<table class="baudio_table" border="0">' + insert + ' <tr><td><button id="baudio_{0}" type="button" class="btn bn disabled"><span id ="baudio_s_{0}" class="glyphicon glyphicon-play"></span></button></td></tr><tr><td><span id="baudio_l_c_{0}" class="blabel" >00:00</span><span id="baudio_l_d_{0}" class="blabel" > / 00:00</span></td></tr></table>';
			src = $(this).attr('data-src');
			id = $(this).attr('id');
			

			$(this).append(a.f(id, src));
			$(this).append(t.f(id, title));
			var audioElement = document.getElementById("audio_" + id);
			//save for later
			audioElements.push(audioElement);
			$("#baudio_" + id).click({ ae: audioElement, id: id }, clickManager);
			$("#baudio_" + id).disabled = false;
			audioElement.addEventListener("canplay", canPlay.bind(audioElement), false);
			audioElement.addEventListener("timeupdate", timeUpdate.bind(audioElement), false);
			audioElement.addEventListener("ended", isended.bind(audioElement), false);
		});

		$("source").on("error", function (e) {
			console.log("Error at audio tag level!" + e.target.src+ '; ' + e.target.error + '; ' + e.target.currentSrc);
			problematic_urls = problematic_urls + "<li>" + e.target.src + "</li>";
			//$("#error_details").html(problematic_urls);
			recordError("on loading audio clips", e.target.src);
			//$("#error_loading_files").show();
		});
	});
	var problematic_urls = "";
	/*
		Called when the scale item is clicked
	*/
	function alertForbiddenChange() {
		alert('You should listen until the end.');		
		if ( $(this).attr('name').indexOf('slide')>=0){
				$(this).val(0);
		}else
			$(this).prop('checked', false);		
	}

	/*
		Users should not be able to vot before listening the audio clips until the end.
	*/
	function avoidAnsweringBeforeListeningThrough() {
		var i;
		// Training section
		for (i = 0; i < config['trainingUrls'].length; i++) {
			$('input[name^="t{0}"]'.f(i + 1)).on('change', alertForbiddenChange);
		}
		// Rating section
		for (i = 0; i < config['questionUrls'].length; i++) {
			$('input[name^="q{0}"]'.f(i + 1)).on('change', alertForbiddenChange);
		}
	}

	function getGoldQuestionStat(){
		stat_text = readCookie(config['cookieName'] + "_gstat");
		if (stat_text == null){
			return {'sum':0, 'failed':0, 'warning_showed':0};
		}
		stat = stat_text.split('+');
		stat_data = {'sum':Number(stat[0]), 'failed':Number(stat[1])};
		if (stat.length>2)
			stat_data['warning_showed'] = Number(stat[2]);
		else
			stat_data['warning_showed'] = 0;

		return stat_data;
		
	}

	function saveGoldQuestionStat(stat){
		stat_text = stat['sum'] + "+" + stat['failed']+ "+" + stat['warning_showed'];
		console.log('saveGoldQuestionStat'+ stat_text)
		createCookie(config['cookieName'] + "_gstat", stat_text, config.qualificationValidFor);
	}

	//var stat_are_saved_set = new Set();
	var question_scale_ans_gold = {};
	var question_ans_gold = {};

	/**
	 * Given the stored values in "question_scale_ans_gold", decide whether it should be accepted or not
	 **/
	function updateGoldQuestionInHitStat(full_name, stat){
		let q_name = full_name.split('_')[0];
		scale_list =['noise','ovrl', 'disc', 'col', 'loud', 'reverb','sig'];
		let names = [];
		for (let i=0; i<scale_list.length; i++){
			names.push(q_name + '_' + scale_list[i]);
		}
		if (!(names[0] in question_scale_ans_gold)){
			for (let i=0; i<scale_list.length; i++){
				question_scale_ans_gold [names[i]]= true;
			}				
		}
		tmp = full_name.split('_');
		q_scale_name =q_name + '_' + tmp[tmp.length-1];
		question_scale_ans_gold[q_scale_name] = stat
		
		for (let i=0; i<scale_list.length; i++){
				if (!question_scale_ans_gold [names[i]])
					return false;
		}			
		return true;

	}

	
	/*
		Listener on value change for the Gold question.
		if the answer is correct, change the value of gq_check to 0.

	*/
	function onValueChangeForGoldQuestion() {
		console.log("Ratings:: onValueChangeForGoldQuestion")
		let given_ans = $(this).val()
		let name = $(this).attr('name')
		goldClipAns = config['goldClip']

		tmp = name.split('_');
		scale = tmp[tmp.length-1];
		ans = goldClipAns[scale+'_ans'];		
		console.log("Name: "+name+ ", scale: "+scale+", ans: "+ans);
		if (ans == null || ans == undefined || ans.trim().length ==0)
			return;
				
		stat = getGoldQuestionStat();
		console.log('current stat: faild '+stat['failed']+ ', sum: '+stat['sum']);
		is_correct = true;
		// check the answers
		if ( !checkGoldQCorrect(Number(given_ans), 1, ans, goldClipAns["url"])){			
			is_correct = false
			console.log("it was false");
		}		

		q_stat = updateGoldQuestionInHitStat(name, is_correct);
		q_name = name.split('_')[0];
		// check if the question was considered in global stat before
		if  (q_name in question_ans_gold){
			prev_stat = question_ans_gold[q_name];
			// if the changes answer is different (true->false or false->true) then update the global stat
			if (prev_stat != q_stat){
				if (q_stat){					
					stat['failed'] = stat['failed'] - 1;
				}else{					
					stat['failed'] = stat['failed'] + 1;
				}
				question_ans_gold[q_name] = q_stat;
			}
		}else{
			// if the question was not considered before, then update the global stat
			question_ans_gold[q_name] = q_stat;
			stat['sum'] += 1;		
			if (!q_stat){
				stat['failed'] += 1;
			}
		}		
		saveGoldQuestionStat(stat);
		console.log('new stat: faild '+stat['failed']+ ', sum: '+stat['sum']);
	}

	/*
		Listener on value change for the 2nd Gold question.
		if the answer is correct, change the value of gq_check to 0.

	*/
	function onValueChangeFor2ndGoldQuestion(test_id) {		
		console.log("Ratings:: onValueChangeFor2ndGoldQuestion "+ test_id)
		let given_ans = $(this).val()
		let name = $(this).attr('name')
		goldClipAns = config['goldClip2']

		tmp = name.split('_');
		scale = tmp[tmp.length-1];
		ans = goldClipAns[scale+'_ans'];		
		//console.log("Name: "+name+ ", scale: "+scale+", ans: "+ans);
		if (ans == null || ans == undefined || ans.trim().length ==0)
			return;
				
		stat = getGoldQuestionStat();
		//console.log('current stat: faild '+stat['failed']+ ', sum: '+stat['sum']);
		is_correct = true;
		// check the answers
		if ( !checkGoldQCorrect(Number(given_ans), 1, ans, goldClipAns["url"])){			
			is_correct = false
			//console.log("it was false");
		}		

		q_stat = updateGoldQuestionInHitStat(name, is_correct);
		q_name = name.split('_')[0];
		// check if the question was considered in global stat before
		if  (q_name in question_ans_gold){
			prev_stat = question_ans_gold[q_name];
			// if the changes answer is different (true->false or false->true) then update the global stat
			if (prev_stat != q_stat){
				if (q_stat){					
					stat['failed'] = stat['failed'] - 1;
				}else{					
					stat['failed'] = stat['failed'] + 1;
			
				}
				question_ans_gold[q_name] = q_stat;
			}
		}else{
			// if the question was not considered before, then update the global stat
			question_ans_gold[q_name] = q_stat;
			stat['sum'] += 1;		
			if (!q_stat){
				stat['failed'] += 1;
			}
		}		
		saveGoldQuestionStat(stat);
		//console.log('new stat: faild '+stat['failed']+ ', sum: '+stat['sum']);
	}

	/*
		Listener on value change for the trapping question.
		if the answer is correct, change the value of tp_check to 0.
	*/
	function onValueChangeForTpQuestion() {
		if ($(this).val() == parseInt(config['knownQuestionAns']))
			$('#tp_check').val(0);
		else
			$('#tp_check').val(-1);
		//console.log("gc_check"+$('#tp_check').val())
	}

	/*
		Listener on value change for the trapping question in training.
		if the answer is wrong, show a message.
	*/
	function onValueChangeForTpQuestionInTraining(e) {
		console.log("trapping onValueChangeForTpQuestionInTraining")
		if ($(this).val() != config['knownQuestionInTrainingAns']) {
			console.log("****** " + $(this).val())
			alert('Error: In case you hear an interruption message, please follow the instruction given in the message.');
			$(this).prop('checked', false);
		}

	}

	function onValueChangeForGoldQuestionInTraining(obj, url, c_ans) {
		console.log("gold onValueChangeForGoldQuestionInTraining");

		q_name = $(obj).attr('name');
		tmp = q_name.split('_');
		scale = tmp[tmp.length-1];
		ans = c_ans[scale];		
		if (ans == null)
			return;

		if ( !checkGoldQCorrect(Number($(obj).val()), ans["var"], ans["ans"], c_ans["url"])){			
			alert(ans["msg"]);
			$(obj).prop('checked', false);
			return false;
		}
	}

	var listenersSetRating = new Set();

	/*
		Called when the audio in rating section by the given id is completely played.
		Now user can rate the quality.
	*/
	function playedAudioQ(id) {
		// parallel session check
		isAnyParallelSession();
		input_id = id.split("_")[0];
		console.log('input_id :'+input_id);

		questionNumber= input_id.substring(1);
		if (!areAllSubQuestionsAnswered(questionNumber, false)) {
			console.log("*** stay in loop");
			document.getElementById("baudio_" + id).click();
			isAudioInLoop = true;			
		}

		if (!listenersSetRating.has(input_id)){
			// check if it was the trapping question
			if ($('span[id="' + id + '"]').attr("data-src") == config['knownQuestionUrl']) {
				element = $('input[name^="' + input_id + '_"]');
				element.unbind('change');
				element.on('change', onValueChangeForTpQuestion);

			} else if ($('span[id="' + id + '"]').attr("data-src") == config['goldClip']['url']) {
				console.log('playedAudioQ activate onValueChangeForGoldQuestion');
				element = $('input[name^="' + input_id + '_" i]');
				element.unbind('change');
				element.on('change', onValueChangeForGoldQuestion);
			} else if ($('span[id="' + id + '"]').attr("data-src") == config['goldClip2']['url']) {
				console.log('playedAudioQ activate onValueChangeFor2ndGoldQuestion');
				element = $('input[name^="' + input_id + '_" i]');
				element.unbind('change');
				element.on('change', onValueChangeFor2ndGoldQuestion);
				// find all 
			} else {
				$('input[name^="' + input_id + '_"]').off('change');
				// check if already this HIT is counted
				if (!hitCounterIncreased) {
					updateCounterCookie(config['cookieName'] + "_counter", 1);
					hitCounterIncreased = true
				}
			}
			//enableSliderAfterPlayedAudio(input_id);
			listenersSetRating.add(input_id);
		}
	}


	var list_train_samples_finished = new Set();
	/*
		Called when the audio in training instruction section by the given id is completely played.
		Now user can rate the quality.
	*/
	function inst_finished(id) {
		console.log(id);
		list_train_samples_finished.add(id);		
		if ($('#inst_check').is(':checked')) {
			console.log('checked box');
			// check if all the training samples are finished
			console.log('N finished'+ list_train_samples_finished.size);
			if (list_train_samples_finished.size == 10) {
				console.log('start activating');
				actiavteTraining();
				createCookie(config['cookieName'] + "_instra", "un_important", config['qualificationValidFor']);
			}
		}else{
			console.log('box is not checked');
		}
	}

	function actiavteTraining(){
		$("#training").removeClass("disabled_section");
	}


	/*
		Called when user answers to one question from setup
		(i.e. q2. math question). Here the cookie will be added/updated
	*/
	function userAnsweringToSetupQuestions() {
		createCookie(config['cookieName'] + "_setup", "un_important", config['showSetupEveryMinutes']);
		$('input[name="math"]').off('change');
	}

</script>

<script type="text/javascript" id="js_part3"  nonce="csp_nonce_token">

	/*
		functions responsible to headset check
	*/
	function isHeadsetOn(webrtc_raw) {
		keywords = ["headphone", "headset", "airpod", "usb audio device"]
		for (var i = 0; i < keywords.length; i++) {
			if (webrtc_raw.includes(keywords[i]))
				return true;
		}
		return false;
	}

	const constraints = {
		audio: true,
		video: false
	};

	/*
		Async function to check the list of audio devices when the user allowed
	*/
	const startHeadsetCheck = async function () {
		$('#status').html("waiting for allowance...")
		await navigator.mediaDevices.getUserMedia(constraints);

		navigator.mediaDevices.enumerateDevices()
			.then(devices => {
				var device_list = "";
				for (var i = 0; i < devices.length; i++) {
					if (devices[i].kind.startsWith('audio')) {
						device_list = device_list + devices[i].kind + ":" + devices[i].label.toLowerCase() + "+";
					}
				}
				headsetDetected = isHeadsetOn(device_list);
				$("#webrtc_raw").val(device_list);
				$("#use_headset").val(headsetDetected);
				$("#status").html("Done. Please continue.");
			});
	}

	/*
		shuffle function for randomization of items
	*/
	function shuffle(a) {
		var j, x, i;
		for (i = a.length - 1; i > 0; i--) {
			j = Math.floor(Math.random() * (i + 1));
			x = a[i];
			a[i] = a[j];
			a[j] = x;
		}
		return a;
	}

	/* --- P.835 Specific methods ---*/
	var currentElementForTrial = [];
	var elements = [[]];	
	var question_lists = ['q{0}_noise', 'q{0}_disc', 'q{0}_col', 'q{0}_loud', 'q{0}_reverb','q{0}_sig', 'q{0}_ovrl'];	
	var unansweredQuestions = new Set();

	// for training
	var currentElementForTrialTraining = [];
	var elementsTraining = [[]];
	var question_listsTraining = ['t{0}_noise', 't{0}_disc', 't{0}_col', 't{0}_loud', 't{0}_reverb', 't{0}_sig', 't{0}_ovrl'];
	var unansweredQuestionsTraining = new Set();

	function getQuestionNames(list, is_training){
		let ql = question_lists;
		if (is_training)
			ql = question_listsTraining;
		q_name = []
		for (var i = 0; i < list.length; i++) {
			q_name.push(ql[list[i]-1]);
		}
		return q_name;
	}

	function getQuestionNumber(list){
		let nums =new Array(list.length).fill(0);
		for (var i = 0; i < list.length; i++) {
			nums[list[i]-1] = i+1;
		}
		return nums;
	}

	/*
	<div class="row"> 
		<div class="col-sm-3 infobox " title="Synonyms for Continuous" ><b>Continuous:</b></br>Smooth</br>Steady</br>Clean</div>    
		<div class="col-sm-6"> </div>   						
		<div class="col-sm-3 infobox right-box" title="Synonyms for Discontinuous"><b>Discontinuous:</b></br>Chopped </br> Shaky </br>Pops/Clicks</div>
	</div>

	<div class="row">
		<div class="col-sm-3 infobox " title="Synonyms for Uncolored" ><b>Uncolored</b></br>Bright </br> Natural </br> Full</div>
		<div class="col-sm-6"></div>						
		<div class="col-sm-3 infobox right-box" title="Synonyms for Colored"><b>Colored</b></br>Muffled</br>Robotic  </br>Thin </div>
	</div>

	*/

	function get_acr_tab(order, is_training){
		Q = 'T';
		var overhead = `<div class="tab-pane fade {2}" id="T{0}-panel" role="tabpanel" aria-labelledby="T{0}-tab">
		<p></p>
		<div class="row">
			<div class="col-sm-3"></div>
			<div class="col-sm-6">
				<p style="margin-top:10px;">Listen to the following audio sample </p>
				<p align="center"> <span class="baudio loop" id="t{0}_audio" data-onfinished="playedAudioTraining" data-src="{1}" >&nbsp;</span></p>
			</br></br>
				<datalist id="tickmarks"><option value="1"></option><option value="2"></option><option value="3"></option><option value="4"></option><option value="5"></option></datalist>`;
	
		var noisiness_org= `<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-noise-slider" class="form-label">Noisiness</label></br>
					<p style="margin-top:10px;">How <b>noisy</b> is this speech sample? </p>
					<div class="row">
						<div class="col-sm-3 infobox "  title="Synonyms for Not Noisy" ><b>Not noisy:</b></br>Clear</br>Quiet background</br>Clean</div>	
						<div class="col-sm-6" ></div>						
                        <div class="col-sm-3 infobox right-box" title="Synonyms for Noisy"><b>Noisy:</b></br>Hissing </br>Buzzy </br>Staticky </div>
					</div>
					<div class="row" style="text-align:center; margin:0px">
						<span id="T{0}_rangevalue" class="slider-value" hidden>?</span>
					</div>
					<input type="range" min="1" max="5"  step="1" value="0" class="slider_hide" id="T{0}-noise-slider" name="t{0}_slide_noise" list="tickmarks" required >

                    <label for="noisy" class="pull-left">Not noisy</label>
                    <label for="" class="pull-right">Noisy</label>					
				</div></br></br></br>`;

		var noisiness = `
			<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-noise-slider" class="form-label">Noisiness</label></br>
					<p style="margin-top:10px;">How <b>noisy</b> is this speech sample?</p>
					<div class="row trainingFieldset" style="margin-bottom:0px;"> 
						<table class="table scale-like-radio" cellspacing="0" cellpadding="0" style="text-align: center;">
							<tbody>
							<tr>
								<td> <label><input type="radio" name="t{0}_noise" value="5"></label></td>
								<td> <label><input type="radio" name="t{0}_noise" value="4"></label></td>
								<td> <label><input type="radio" name="t{0}_noise" value="3"></label></td>
								<td> <label><input type="radio" name="t{0}_noise" value="2"></label></td>
								<td> <label><input type="radio" name="t{0}_noise" value="1"></label></td>
								
							</tr>
							</tbody>
						</table>
						<label for="noisy" class="pull-left">Not noisy</label>
                   		<label for="" class="pull-right">Noisy</label>	
					</div>
					<div class="row">
						<div class="col-sm-4 infobox">Clean/Clear</br>Noiseless</br>Not hissing</div>
						<div class="col-sm-5"></div>						
                        <div class="col-sm-3 infobox right-box">Buzzy </br>Hissing </br>Clanging</div>
					</div>									
				</div></br></br></br>
			`;

		var disc_org = `<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-discontinuity-slider" class="form-label">Discontinuity</label></br>
					<p style="margin-top:10px;">How much <b>discontinuity</b> is in this speech sample? </p>
					<div class="row"> 
						<div class="col-sm-3 infobox " title="Synonyms for Continuous" ><b>Continuous:</b></br>Steady</br>Even</br>Smooth / Clean</div>    
						<div class="col-sm-6"> </div>   						
                        <div class="col-sm-3 infobox right-box" title="Synonyms for Discontinuous"><b>Discontinuous:</b></br>Choppy</br>Shaky</br>Pops/Clicks</div>
					</div>
					
					<input type="range" min="1" max="5" step="1" value="0" class="slider_hide" id="T{0}-discontinuity-slider" name="t{0}_slide_disc" list="tickmarks" required>					
					<label for="discontinous" class="pull-left">Continuous</label>
					<label for="" class="pull-right">Discontinuous</label>
				</div></br></br></br>`;
		
		var disc = `
			<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-discontinuity-slider" class="form-label">Discontinuity</label></br>
					<p style="margin-top:10px;">How much <b>discontinuity</b> is in this speech sample?</p>
					<div class="row trainingFieldset" style="margin-bottom:0px;"> 
						<table class="table scale-like-radio" cellspacing="0" cellpadding="0" style="text-align: center;">
							<tbody>
							<tr>
								<td> <label><input type="radio" name="t{0}_disc" value="5"></label></td>
								<td> <label><input type="radio" name="t{0}_disc" value="4"></label></td>
								<td> <label><input type="radio" name="t{0}_disc" value="3"></label></td>
								<td> <label><input type="radio" name="t{0}_disc" value="2"></label></td>
								<td> <label><input type="radio" name="t{0}_disc" value="1"></label></td>
								
							</tr>
							</tbody>
						</table>
						<label for="discontinous" class="pull-left">Continuous</label>
						<label for="" class="pull-right">Discontinuous</label>
					</div>
					<div class="row">
						<div class="col-sm-3 infobox">Steady</br>Smooth</br>Clean</div>
						<div class="col-sm-6"></div>						
                        <div class="col-sm-3 infobox right-box">Shaky</br>Choppy</br>Uneven</div>
					</div>									
				</div></br></br></br>
			`;

		var col_org = `
			<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-coloration-slider" class="form-label">Coloration</label></br>
					<p style="margin-top:10px;">How much <b>coloration</b> is in this speech sample? </p>
					<div class="row">
						<div class="col-sm-3 infobox " title="Synonyms for Uncolored" ><b>Uncolored</b></br>Normal</br>Not nasally</br>Natural</div>
						<div class="col-sm-6"></div>						
                        <div class="col-sm-3 infobox right-box" title="Synonyms for Colored"><b>Colored</b></br>Distant / far</br>Muffled</br>Thin</div>
					</div>
					<input type="range" min="1" max="5" step="1" value="0" class="slider_hide" id="T{0}-coloration-slider" name="t{0}_slide_col" list="tickmarks" required>
					<label for="" class="pull-left">Uncolored</label>
					<label for="" class="pull-right">Colored</label>
				</div></br></br></br>
		`;

		var col = `
			<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-coloration-slider" class="form-label">Coloration</label></br>
					<p style="margin-top:10px;">How much <b>coloration</b> is in this speech sample?</p>
					<div class="row trainingFieldset" style="margin-bottom:0px;"> 
						<table class="table scale-like-radio" cellspacing="0" cellpadding="0" style="text-align: center;">
							<tbody>
							<tr>
								<td> <label><input type="radio" name="t{0}_col" value="5"></label></td>
								<td> <label ><input type="radio" name="t{0}_col" value="4"></label></td>
								<td> <label><input type="radio" name="t{0}_col" value="3"></label></td>
								<td> <label><input type="radio" name="t{0}_col" value="2"></label></td>
								<td> <label><input type="radio" name="t{0}_col" value="1"></label></td>
								
							</tr>
							</tbody>
						</table>
						<label for="" class="pull-left">Uncolored</label>
						<label for="" class="pull-right">Colored</label>
					</div>
					<div class="row">
						<div class="col-sm-3 infobox ">Normal</br>Natural</br>Direct</div>
						<div class="col-sm-6"></div>						
                        <div class="col-sm-3 infobox right-box">Distant/Far</br>Thin</br>Muffled</div>
					</div>									
				</div></br></br></br>
			`;

		var loud_org = `
			<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-loudness-slider" class="form-label">Loudness</label></br>
					<p style="margin-top:10px;">Does this speech sample have <b>optimal loudness</b>? </p>
					<div class="row">
						<div class="col-sm-3 infobox "><b>Optimal Loudness</b></br>Comfortable</br>Pleasant</br>Easy to hear</div>
						<div class="col-sm-6"></div>						
                        <div class="col-sm-3 infobox right-box"><b>Sub-optimal loudness</b></br>Too loud</br>Too quiet</br>Varying volume</br></div>
					</div>				
					<input type="range" min="1" max="5" step="1"  value="0"class="slider_hide" id="T{0}-loudness-slider" name="t{0}_slide_loud" list="tickmarks" required>
					<div>
					<label for="" class="pull-left" >Optimal</br>loudness</label>
					<label for="" class="pull-right">Sub-optimal</br>loudness</label>
					</div>
				</div></br></br></br>
		`;

		var loud = `
			<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-loudness-slider" class="form-label">Loudness</label></br>
					<p style="margin-top:10px;">Does this speech sample have <b>optimal loudness</b>?</p>
					<div class="row trainingFieldset" style="margin-bottom:0px;"> 
						<table class="table scale-like-radio" cellspacing="0" cellpadding="0" style="text-align: center;">
							<tbody>
							<tr>
								<td> <label><input type="radio" name="t{0}_loud" value="5"></label></td>
								<td> <label ><input type="radio" name="t{0}_loud" value="4"></label></td>
								<td> <label><input type="radio" name="t{0}_loud" value="3"></label></td>
								<td> <label><input type="radio" name="t{0}_loud" value="2"></label></td>
								<td> <label><input type="radio" name="t{0}_loud" value="1"></label></td>
								
							</tr>
							</tbody>
						</table>
						<label for="" class="pull-left" >Optimal</br>loudness</label>
						<label for="" class="pull-right">Sub-optimal</br>loudness</label>
					</div>
					<div class="row">
						<div class="col-sm-3 infobox ">Easy to hear</br>Pleasant</br>Level</div>
						<div class="col-sm-6"></div>						
                        <div class="col-sm-3 infobox right-box">Too quiet</br>Varying volume</br>Too loud</div>
					</div>				
					
				</div></br></br></br>
			`;


		var reverb_org = `
			<div class="slidecontainer counter" id="T{0}_elmt_X" >
					<label for="T{0}-reverb-slider" class="form-label">Reverb</label></br>
					<p style="margin-top:10px;">How much <b>reverberation</b> is in this speech sample? </p>
					<div class="row">
						<div class="col-sm-3 infobox "><b>No reverb</b></br>No echo</br>Clean</br>Clear</div>
						<div class="col-sm-6"></div>						
                        <div class="col-sm-3 infobox right-box"><b>High reverb</b></br>Echo</br>Cave sound</br>Tunnel sound</div>
					</div>				
					<input type="range" min="1" max="5" step="1" value="0" class="slider_hide" id="T{0}-reverb-slider" name="t{0}_slide_reverb" list="tickmarks" required>
					
					<label for="" class="pull-left">No reverb</label>
					<label for="" class="pull-right">High reverb</label>
				</div></br></br></br>`;

		
		var reverb = `
			<div class="slidecontainer counter" id="T{0}_elmt_X">
					<label for="T{0}-reverb-slider" class="form-label">Reverb</label></br>
					<p style="margin-top:10px;">How much <b>reverberation</b> is in this speech sample? </p>
					<div class="row trainingFieldset" style="margin-bottom:0px;"> 
						<table class="table scale-like-radio" cellspacing="0" cellpadding="0" style="text-align: center;">
							<tbody>
							<tr>
								<td><label><input type="radio" name="t{0}_reverb" value="5"></label></td>
								<td><label><input type="radio" name="t{0}_reverb" value="4"></label></td>
								<td><label><input type="radio" name="t{0}_reverb" value="3"></label></td>
								<td><label><input type="radio" name="t{0}_reverb" value="2"></label></td>
								<td><label><input type="radio" name="t{0}_reverb" value="1"></label></td>
								
							</tr>
							</tbody>
						</table>
						<label for="" class="pull-left">No reverb</label>
						<label for="" class="pull-right">High reverb</label>
					</div>
					<div class="row">
						<div class="col-sm-3 infobox ">Clear</br>Clean</br>No echo</div>
						<div class="col-sm-6"></div>						
                        <div class="col-sm-3 infobox right-box">Echo</br>Sound reflection</br>Tunnel sound</div>
					</div>				
					
				</div></br></br></br>`;

		
				var sig =`
		<div>
		<label for="fieldset_t{0}" class="form-label">Signal Quality</label></br>
				<p style="margin-top:10px;">Attending <b>ONLY to the entire SPEECH SIGNAL</b>, select the category which best describes the sample you just heard.</p>
				<div id="T{0}_elmt_X" class ="counter">
				<fieldset id="fieldset_t{0}_sig" class="trainingFieldset" title="">
					<table class="table md scale" cellspacing="0" cellpadding="0">
					<thead>
						<tr>
							<th >the SPEECH SIGNAL in this sample was</th>
							<th class="c" >Score</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_sig" value="5">Not distorted</label></div>
							</td>
							<td class="c">5</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_sig" value="4">Slightly distorted</label></div>
							</td>
							<td class="c">4</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_sig" value="3">Somewhat distorted</label></div>
							</td>
							<td class="c">3</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_sig" value="2">Fairly distorted</label></div>
							</td>
							<td class="c">2</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_sig" value="1" required="">Very distorted</label></div>
							</td>
							<td class="c">1</td>
						</tr>
					</tbody>
					</table>
				</fieldset>
				</div>
				<p></p></br></br></br></div>`;

		var ovrl = `
		<label for="fieldset_t{0}" class="form-label">Overall Quality</label></br>
				<p style="margin-top:10px;">How do you rate the <b>overall quality</b> of the speech sample? </p>
				<div id="T{0}_elmt_X" class ="counter">
				<fieldset id="fieldset_t{0}_ovrl" class="trainingFieldset" title="">
					<table class="table md scale" cellspacing="0" cellpadding="0">
					<thead>
						<tr>
							<th >Quality of the speech</th>
							<th class="c" >Score</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_ovrl" value="5">Excellent</label></div>
							</td>
							<td class="c">5</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_ovrl" value="4">Good</label></div>
							</td>
							<td class="c">4</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_ovrl" value="3">Fair</label></div>
							</td>
							<td class="c">3</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_ovrl" value="2">Poor</label></div>
							</td>
							<td class="c">2</td>
						</tr>
						<tr>
							<td>
								<div class="radio" ><label ><input type="radio" name="t{0}_ovrl" value="1" required="">Bad</label></div>
							</td>
							<td class="c">1</td>
						</tr>
					</tbody>
					</table>
				</fieldset>
				</div>
				<p></p>
			</div>
			<div class="col-sm-3"></div>
		</div>
		<p></p>
		</div>`;
		list ={
			'1': loud,
			'2': reverb,
			'3': disc,
			'4': col,
			'5': sig, //placeholder for sig
			'6':noisiness,
			'7':ovrl
		}
		
		var html = overhead;
		tmp_list = order.split("_");
		for (i=0; i<tmp_list.length; i++){
			tmp = list[tmp_list[i]];
			tmp = tmp.replace("_elmt_X", "_elmt_" + i);
			html = html + tmp;
		}
		if (!is_training){
			html = html.replaceAll("t{0}", "q{0}").replaceAll("trainingFieldset", "ratingFieldset").replaceAll("T{0}", "Q{0}").replaceAll("playedAudioTraining", "playedAudioQ");
		}
		return html;

	}
	/*
		Generate the training section
		lod, rev, col, dis

	*/
	function generate_training_section() {
		acr_nav_tab = '<li class="nav-item {1}"><a class="nav-link" data-toggle="tab" href="#T{0}-panel" id="T{0}-tab" role="tab" aria-controls="T{0}" {2} onclick="pauseAll();">Trial {0}</a></li>';		

		// set the order of scale
		order = $("#p835_order").val();
		var acr_tab = get_acr_tab(order, true);
		
		// this will show which url was shown by in which question as their orther will be randomized
		input_template = '<input id="T{0}_URL" name="T{0}_URL" type="hidden" value="{1}" />';

		if (JSON.parse(config['randomizeTrainingQuestions']))
			urls = shuffle(config['trainingUrls']);
		else
			urls = config['trainingUrls'];

		//elementsTraining = new Array(urls.length);
		currentElementForTrialTraining = new Array(urls.length);

		var i;
		for (i = 0; i < urls.length; i++) {
			//elementsTraining[i] = [];
			if (i == 0) {
				$('#trainingTabs').append(acr_nav_tab.f(i + 1, 'active', 'aria-selected="true"'));
				$('#nav-tabContent').append(acr_tab.f(i + 1, urls[i], 'in active'));
			} else {
				$('#trainingTabs').append(acr_nav_tab.f(i + 1, '', ''));
				$('#nav-tabContent').append(acr_tab.f(i + 1, urls[i], ''));
			}
			$('#nav-tabContent').append(input_template.f(i + 1, urls[i]));
			
			el = []
			for (j = 0; j < question_listsTraining.length; j++) {
				tmp_name = question_listsTraining[j].f(i + 1);
				//el.push(document.getElementByName(tmp_name));
				// add questions to the set of unanswered one
				unansweredQuestionsTraining.add(tmp_name);
				//set the listeners to change to next question when vote is given

				//$('input[name=' + tmp_name + ']').click({ trial_num: i, num: j, isTraining: true, id:tmp_name }, onRating);
				$('input[name=' + tmp_name + ']').click({trial_num: i, isTraining: true, id:tmp_name }, onRating);
			}
			//elementsTraining[i] = el;
			// initialize the GUI
			//hideAllElementsOnlyNumT(i, 0);
			//currentElementForTrialTraining[i] = 0;
			
		}
		$('.question_number_training').html(urls.length);
		trainingStimulusPlayed = new Array(urls.length).fill(0);
		//console.log("Training questions are set:"+ trainingStimulusPlayed );
	}


	/*
		Generate rating section
	*/
	function generate_rating_section() {

		acr_nav_tab = '<li class="nav-item {1}"><a class="nav-link" data-toggle="tab" href="#Q{0}-panel" id="Q{0}-tab" role="tab" aria-controls="Q{0}" {2} onclick="pauseAll();">Trial {0}</a></li>';
			
		// this will show which url was shown in which question as their order will be randomized
		input_template = '<input id="Q{0}_URL" name="Q{0}_URL" type="hidden" value="{1}" />';
		if (JSON.parse(config['randomizeRatingQuestions'])) {
			urls = shuffle(config['questionUrls']);
		} else {
			urls = config['questionUrls'];
		}

		elements = new Array(urls.length);
		currentElementForTrial = new Array(urls.length);

		// set the order of scale
		order = $("#p835_order").val();
		var acr_tab = get_acr_tab(order, false);

		var i;
		for (i = 0; i < urls.length; i++) {
			//elements[i] = [];
			if (i == 0) {
				$('#nav-tab-ul').append(acr_nav_tab.f(i + 1, 'active', 'aria-selected="true"'));
				$('#nav-tabContent-rating').append(acr_tab.f(i + 1, urls[i], 'in active'));
			} else {
				$('#nav-tab-ul').append(acr_nav_tab.f(i + 1, '', ''));
				$('#nav-tabContent-rating').append(acr_tab.f(i + 1, urls[i], ''));
			}

			$('#nav-tabContent-rating').append(input_template.f(i + 1, urls[i]));
			//el = []


			for (j = 0; j < question_lists.length; j++) {
				tmp_name = question_lists[j].f(i + 1);
				//el.push(document.getElementById(tmp_name));
				// add questions to the set of unanswered one
				unansweredQuestions.add(tmp_name);
				//set the listeners to change to next question when vote is given
				$('input[name=' + tmp_name + ']').click({trial_num: i, isTraining: false , id:tmp_name}, onRating);
			}
			//elements[i] = el;
			// initialize the GUI
			//hideAllElementsOnlyNumR(i, 0);
			//currentElementForTrial[i] = 0;
		}
		$('.question_number').html(urls.length);
		recordTTFB();
	}


	function hideAllElementsOnlyNumT(trial_num, num) {
		pauseAll();
		dot = '<span class="dot {0}"></span>';
		progress_el_name = '#progress_T_{0}'.f(trial_num + 1);
		$(progress_el_name).empty();
		el = elementsTraining[trial_num];

		if (unansweredQuestionsTraining.has(question_listsTraining[num].f(trial_num + 1)))
			$('#next_t{0}_button'.f(trial_num + 1)).prop('disabled', true);
		else
			$('#next_t{0}_button'.f(trial_num + 1)).prop('disabled', false);
		
		for (i = 0; i < el.length; i++) {
			el[i].style.display = "none";
			q_name = question_listsTraining[i].f(trial_num + 1);
			if (!unansweredQuestionsTraining.has(q_name))
				$(progress_el_name).append(dot.f(i == num ? 'done current' : 'done'));
			else
				$(progress_el_name).append(dot.f(i == num ? 'current' : ''));
		}

		$('#' + el[num].id).fadeIn(400);
	}

	function hideAllElementsOnlyNumR(trial_num, num) {
		pauseAll();
		dot = '<span class="dot {0}"></span>';
		progress_el_name = '#progress_{0}'.f(trial_num + 1);
		$(progress_el_name).empty();
		el = elements[trial_num];
		if (unansweredQuestions.has(question_lists[num].f(trial_num + 1)))
			$('#next_q{0}_button'.f(trial_num + 1)).prop('disabled', true);
		else
			$('#next_q{0}_button'.f(trial_num + 1)).prop('disabled', false);
		for (i = 0; i < el.length; i++) {
			el[i].style.display = "none";
			q_name = question_lists[i].f(trial_num + 1);
			if (!unansweredQuestions.has(q_name))
				$(progress_el_name).append(dot.f(i == num ? 'done current' : 'done'));
			else
				$(progress_el_name).append(dot.f(i == num ? 'current' : ''));
		}
		$('#' + el[num].id).fadeIn(400);
	}

	function prevQuestion(trial_num, isTraining) {
		if (isTraining) {
			currentElementForTrialTraining[trial_num]--;
			if (currentElementForTrialTraining[trial_num] < 0)
				currentElementForTrialTraining[trial_num] = 0;
			hideAllElementsOnlyNumT(trial_num, currentElementForTrialTraining[trial_num]);
		} else {
			currentElementForTrial[trial_num]--;
			if (currentElementForTrial[trial_num] < 0)
				currentElementForTrial[trial_num] = 0;
			hideAllElementsOnlyNumR(trial_num, currentElementForTrial[trial_num]);
		}
	}


	function nextQuestion(trial_num, isTraining) {
		pauseAll();
		isAudioInLoop = false;
		if (isTraining) {
			console.log("trial_num:"+trial_num);
			
			if (unansweredQuestionsTraining.size ==0){
				console.log('####### all questions in training are answered');
				
				trainingIsFinished();
			}
			/**
			name = question_listsTraining[currentElementForTrialTraining[trial_num]].f(trial_num + 1);
			if (typeof $('input[name=' + name + ']:checked').val() === "undefined")
				return;
			else{
				unansweredQuestionsTraining.delete(name);
				if (unansweredQuestionsTraining.size ==0){
					console.log('####### all questions in training are answered');
					trainingIsFinished();
				}
			}
			currentElementForTrialTraining[trial_num]++;
			if (currentElementForTrialTraining[trial_num] >= elementsTraining[trial_num].length) {
				currentElementForTrialTraining[trial_num] = elementsTraining[trial_num].length - 1;
				hideAllElementsOnlyNumT(trial_num, currentElementForTrialTraining[trial_num]);
				if (trial_num + 1 < config['trainingUrls'].length) {
					trialEnded(true);
				}
			} else
				hideAllElementsOnlyNumT(trial_num, currentElementForTrialTraining[trial_num]);
				**/

		} 
		/**
		else {
			name = question_lists[currentElementForTrial[trial_num]].f(trial_num + 1);
			if (typeof $('input[name=' + name + ']:checked').val() === "undefined")
				return;
			else
				unansweredQuestions.delete(name);
			currentElementForTrial[trial_num]++;
			if (currentElementForTrial[trial_num] >= elements[trial_num].length) {
				currentElementForTrial[trial_num] = elements[trial_num].length - 1;
				hideAllElementsOnlyNumR(trial_num, currentElementForTrial[trial_num]);
				if (trial_num + 1 < config['questionUrls'].length) {
					trialEnded(false);
				}
			} else
				hideAllElementsOnlyNumR(trial_num, currentElementForTrial[trial_num]);
		}**/
	}

	function isTpQuestionInTraining(id) {
		if ($('span[id="' + id + '"]').attr("data-src") == config['knownQuestionInTrainingUrl'])
			return true;
		return false;

	}

	function isGoldQuestionInTraining(id) {
		training_clip = getGoldQuestionInTrainingInfo($('span[id="' + id + '"]').attr("data-src"));
		if (training_clip!=null)
			return true;
		return false;

	}

	function isTpQuestionInRating(id) {
		if ($('span[id="' + id + '"]').attr("data-src") == config['knownQuestionUrl'])
			return true;
		return false;

	}
	function trainingIsFinished(){
		createCookie(config['cookieName'] + "_training", "un_important", config['forceRetrainingInHours'] * 60);
		$("#rating_section").removeClass("disabled_section");		
	}
	
	function show_detailed_instruction(){
		$("#details_instruction").show();
	}

	function is_audio_playing(id){
		audio = document.getElementById('audio_'+id+"_audio");
		return !audio.paused;
	}

	function onRating(event) {
		console.log("+ ++ ++ + ++ onRating: " );
		trial_num = event.data.trial_num;
		//num = event.data.num;
		isTraining = event.data.isTraining;
		id = event.data.id;
		console.log("**** id:"+id);
		if (isTraining) {
			// find the question name						
			tmp_name = id.split("_")[0];
			if (!areAllSubQuestionsAnswered(trial_num+1, true) && !is_audio_playing(tmp_name)){
				$('input[name=' + id + ']').prop('checked', false);			
				alert('You should let audio play in a loop when rating.');				
				return;
			}

			// 1. return if the audio is not played.
			name = "audio_n_finish_" + 't{0}'.f(trial_num + 1) + "_audio";
			if ($('input[name=' + name + ']').val() == 0)
				return;

			if (isTpQuestionInTraining(tmp_name + "_audio")) {
				// check if the answer is false then the onRating should not proceed
				if ($(this).val() != config['knownQuestionInTrainingAns']) {
					return;
				}
			}
			console.log("Answer:"+$('input[name=' + id + ']').val());
			if (isGoldQuestionInTraining(tmp_name + "_audio")) {
				console.log('IT IS GOLD URL in TRAINING:');
				// check if the answer is false then the onRating should not proceed
				training_q_data = getGoldQuestionInTrainingInfo($('span[id="' + tmp_name + '_audio"]').attr("data-src"));

				tmp = id.split('_');
				scale = tmp[tmp.length-1];
				ans = training_q_data[scale];					
				if (ans != null ) {
					if ( !checkGoldQCorrect(Number($(this).val()), ans["var"], ans["ans"], training_q_data["url"])){
						return;
					}									
				}else{
					// this scale is not in gold, so remove the listener and make it active
					$('input[name="'+id+'"]').off('change');					
				}
			}

			
			console.log('removing '+ id);
			unansweredQuestionsTraining.delete(id);
			//scroll to the next question
			scroll_to_next_input(id);
			
			if (areAllSubQuestionsAnswered(trial_num+1, true)){
				console.log("areAllSubQuestionsAnswered::::: true" + (trial_num+1).toString() );
				if (isAudioInLoop){
					pauseAll();
					isAudioInLoop = false;
				}
				
			}else
				return;

		} else {
			// find the question name						
			tmp_name = id.split("_")[0];
			
			if (!areAllSubQuestionsAnswered(trial_num+1, false) && !is_audio_playing(tmp_name)){
				//$('input[name=' + id + ']').val(0);		
				console.log(id);
				$('input[name=' + id + ']').prop('checked', false);				
				alert('You should let audio play in a loop when rating.');								
				return;
			}

			name = "audio_n_finish_" + 'q{0}'.f(trial_num + 1) + "_audio";
			if ($('input[name=' + name + ']').val() == 0)
				return;

			createCookie(config['cookieName'] + "_training", "un_important", config['forceRetrainingInHours'] * 60);
			order = $("#p835_order").val();
			createCookie(config['cookieName']+'_pmulti_order', order, config['forceRetrainingInHours']*60);
			unansweredQuestions.delete(id);
			scroll_to_next_input(id);
			check_submit_button();
			console.log("Answer:"+$('input[name=' + id + ']').val());
			if (areAllSubQuestionsAnswered(trial_num+1, false)){
				console.log("areAllSubQuestionsAnswered::::: true" + (trial_num+1).toString() );

				if (isAudioInLoop){
					pauseAll();
					isAudioInLoop = false;
				}
				
			}else
				return;
		}
		nextQuestion(trial_num, isTraining);
	}

	function scroll_to_next_input(current_input_id){
		//scroll to the next question
		console.log("scroll_to_next_input: "+current_input_id);
		p = $('input[name="'+current_input_id+'"]').first().closest('.counter');
		el_id = p.attr('id').split('_');
		el_id = Number(el_id[el_id.length-1]);
		new_id = el_id +1;
		console.log("scroll_to_next_input: "+el_id+" "+new_id);
		if (el_id<6){
			elmt = document.getElementById(p.attr('id').replace("_elmt_"+el_id, "_elmt_"+new_id))
			if (!isElementInViewport(elmt))
				elmt.scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});		
			
		}else if (el_id==6){
			if (p.attr('id').startsWith('T'))
				document.getElementById('training_end').scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});
			else
				document.getElementById('rating_end').scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});
		} 	
	}

	function check_submit_button() {
		if (unansweredQuestions.size == 0) {
			$("#submitButton").prop('disabled', false);
		}
	}

	function trialEnded(isTraining) {
		if (isTraining)
			showNextQuestionInTrainingSection();
		else
			showNextQuestionInRatingSection();
	}

	function help_which_questions_remain() {
		msg = "";
		if (unansweredQuestions.size > 0) {
			msg = 'Following questions remained in the "Ratings" section: \n';
			for (let item of unansweredQuestions)
				msg = msg + '\t' + questionName2Text(item) + '\n';
		} else {
			msg = "All questions in the Rating section are answered, in case the Submit button is still deactivate, please check other sections."
		}
		alert(msg);
	}

	function questionName2Text(qName) {
		const RE_DATE = /q(\d+)_(\w+)/;
		const matchObj = RE_DATE.exec(qName);
		const template = "Trial {0}: {1}";
		console.log(matchObj[2])
		question = "";
		if (matchObj[2] == "sig")
			question = "Speech Signal Quality";
		else if (matchObj[2] == "noise")
			question = "Noisiness";
		else if (matchObj[2] == "disc")
			question = "Discountinuty";
		else if (matchObj[2] == "col")
			question = "Coloration";
		else if (matchObj[2] == "loud")
			question = "Loudness";
		else if (matchObj[2] == "reverb")
			question = "Reverbation";
		else 
			question = "Overall Quality";

		return template.f(matchObj[1], question);
	}
	function gold_warning(){
		console.log('gold_warning');
		let gold_stat = getGoldQuestionStat();	
		gold_stat['warning_showed'] = 1;
		saveGoldQuestionStat(gold_stat);


	}


// --------------- new code

function set_onclick_listeners(){
	document.getElementById("gold_warning_checkbox").onchange = function() { gold_warning(); };
	document.getElementById("Math").onchange = function() { userAnsweringToSetupQuestions(); };
	// same here: <button type="button" class="btn btn-primary center" onclick="startHeadsetCheck()">Start</button>
	document.getElementById("start_headset_check").onclick = function() { startHeadsetCheck(); };
	//<input type="checkbox" id="inst_check" name="instruction" value="understand" onchange="inst_finished('checkbox')">
	document.getElementById("inst_check").onchange = function() { inst_finished('checkbox'); };

	document.getElementById("showPreviousQuestionInTrainingSection").onclick = function() { showPreviousQuestionInTrainingSection(); };
	document.getElementById("showNextQuestionInTrainingSection").onclick = function() { showNextQuestionInTrainingSection(); };
	// <button type="button" class="btn btn-success" id="show_detailed_instruction" onclick="show_detailed_instruction();return false;">
	document.getElementById("show_detailed_instruction").onclick = function() { show_detailed_instruction(); return false; };
	document.getElementById("prev-rating").onclick = function() { showPreviousQuestionInRatingSection(); };
	document.getElementById("next-rating").onclick = function() { showNextQuestionInRatingSection(); };
	// <a id="myLink" href="#" onclick="help_which_questions_remain();return false;">
	document.getElementById("myLink").onclick = function() { help_which_questions_remain(); return false; };

}

</script>


<!--    gold question warining -->
<section class="container" id="gold_warning" hidden>
	<div class="alert alert-danger" role="alert">
		<h5><b>Warning</b></h5>
		<p>The QA system recognized that you provided wrong answer to clips that their answers are know to us in <b class="gold_warning_num"> 0</b>  HITs. 			
			Please carefully read and follow the training instructions again. If QA system detects further failures in <b class="gold_stop_delta"> 0</b>  more HITs, your access to this HIT Group will be blocked to avoid wasting your time and masive rejections.
			You can continue your work, the QA system activated the <b>Training section</b> for you to review the rules again.
		</p>
		</p>
		
		<p><small>The QA system uses multiple quality control metrics (some obvious and some not easily recognizable). </small></p>

		<p> 

			<div class="checkbox">
				<label><input id="gold_warning_checkbox" type="checkbox" value="warining">I read this message carefully and understand it.</label>
			  </div>

		</p>
	</div>
</section>


<!--    Error -->
<section class="container" id="errorSection" hidden>
	<div class="alert alert-danger" role="alert">
		<h5>Error</h5>
		<p>One or more errors are detected during loading this HIT. Please use the following link to send the error to
			us: <a class="email" id="errorEmail" title="Email in HIT" href="">Email</a>.</p>
		<p><b> Meanwhile, please return this HIT and try another one</b>.</p>
	</div>
</section>

<!-- Instructions -->
<section class="container" id="Survey">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#instruction" data-toggle="collapse">Instructions for speech quality assessment</a>
			</h3>
		</div>
		<div class="panel-collapse collapse in" id="instruction">
			<div class="panel-body">
				<p><h2>HIT Type: 804</h2><small>New: we publish different HIT types which may look similar but have different instructions and aims. This number is an identifier for you to recognize them.</small></p>

				<b>Introduction</b>


				<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/process_3.png" alt="scale"
					class="center" style='width: 60%'>
				
				<p>Welcome to this Data Labeling task! You are about to participate in our speech quality assessment task! It is a data labeling task in which you are responsible for providing reliable labels that pass our qualifity control system. This HIT has two +
					two (just every now and then) sections:</p>
				<ul>
					<li><b>Qualification (just once):</b> Check if you are eligible to perform these HITs</li>
					<li><b>Setup (every <b class="setup_time"> 0</b> minutes):</b> Configure your system and validate it
						by answering 6 questions</li>
					<li><b>Detailed instuction (only once):</b> 12 audio samples, and description of scale. It is crucial to understand what you should do.</li>
					<li><b>Training (every <b class="training_time"> 0 </b> hour):</b> <b
							class="question_number_training"> 0 </b> questions, same as "Ratings" but appears again after <b class="training_time"> 0 </b> hour from the last HIT you perform in this group.
					<li><b>Rating:</b> Listen to <b class="question_number"> 0 </b> audio files and give <b>your opinion
							about the quality of the speech</b> you hear.</li>
				</ul>
				<p>You should follow the below mentioned rules, otherwise your answers will be invalid.</p>
				<p><b>Rules:</b></p>
				<ul>
					<li>You must use a <b>headset</b>, not the loudspeaker: otherwise your response will be rejected
					</li>
					<li>You must perform the task in a <b>quiet environment</b></li>
					<li>Do not change the volume after modifying it in the Setup section.</li>
				</ul>
				<div class ="not_show_in_pl">
					<p><b>Payment:</b></p>
					<p>The result of this experiment is <b>very important for us and other scientist</b> working in this
						area. We have methods that analyse the consistency of your answers. We will use these methods to
						rank the submitted assignments according to quality.</p>
					<p>For this experiment, we will pay a base reward of <b>${{cfg.hit_base_payment}}/HIT</b> for every
						accepted HIT. We have made available a set of <b class="max_allowed_hits">0 </b> different HITs. You
						will receive a bonus of:</p>

					<ul>
						<li>${{cfg.quantity_bonus}}/HIT (for a total of <b>${{cfg.sum_quantity}}/HIT</b>) if you submit
							<b>more than {{cfg.quantity_hits_more_than}} HITs</b> or</li>
						<li>${{cfg.quality_bonus}}/HIT (for a total of <b>${{cfg.sum_quality }}/HIT</b>) if you submit
							<b>more than {{cfg.quantity_hits_more_than}} HITs</b> <u>and</u> be in the <b>top
								{{cfg.quality_top_percentage}}% quality group</b>.</li>
					</ul>

					<p>Bonuses will be assigned with in 7 days.</p>
					<b>Please perform up to <b class="max_allowed_hits"> 0 </b> HITs from this group. If you do more than
						that, the <u>rest will be rejected.</u></b>
				</div>
				<h3>Attention: </h3>
				<p>This hit includes one or more Control clips (gold clips). Control clips are ones that we know that answer for and should be very easy to rate (they are clearly very good or very poor). They may target one or more scales. We include control clips in the HIT to ensure raters are paying attention and their environment hasn't changed.
					Wrong answer to control clip(s) will result in rejection of the HIT.</p>

				</p>
					
			</div>
		</div>

	</div>
</section>


<!-- Qualification -->
<section class="container" id="qualification">

	<div class="row col-xs-12 col-md-12">
		<div class="panel panel-info">
			<div class="panel-heading">
				<h3 class="panel-title">
					<a data-toggle="collapse" href="#collapse1">Qualification - Just once</a>
				</h3>
			</div>
			<div id="collapse1" class="panel-collapse collapse in">
				<div class="panel-body">

					<fieldset class="qualificationFieldset"><label>1.&nbsp;What is your gender?</label>
						<div class="radio">
							<label><input type="radio" name="1_gender" value="M" required="">Male</label>
						</div>
						<div class="radio">
							<label><input type="radio" name="1_gender" value="F">Female</label>
						</div>
						<div class="radio disabled">
							<label><input type="radio" name="1_gender" value="O">Other</label>
						</div>
					</fieldset>
					<fieldset class="qualificationFieldset"><label>2.&nbsp;In what year were you born? </label>
						<div class="form-group">
							<input type="text" class="form-control" name="2_birth_year" required="">
						</div>
					</fieldset>

					<fieldset class="qualificationFieldset"><label>3.&nbsp;What is your mother tongue? </label>
						<div class="form-group">
							<input type="text" class="form-control" name="3_mother_tongue" required="">
						</div>
					</fieldset>


					<fieldset class="qualificationFieldset"><label>4.&nbsp; What type of listening devices do you have
							and able to use now (select all)?</label>

						<div class="table-responsive 4_lds">
							<table class="table" border="0" cellpadding="0" cellspacing="0">
								<tbody>
									<tr>
										<td style="width:25%"> <img
												src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/inear.png"
												alt="in-ear headphones" width="100px"> </td>
										<td style="width:25%"> <img
												src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/overear.png"
												alt="Closed back headphones" width="100px"> </td>
										<td style="width:25%"> <img
												src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/louadspeaker.png"
												alt="louadspeaker" width="100px"> </td>
										<td style="width:25%"> <img
												src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/inbuild.png"
												alt="inbuild speakers" width="100px"> </td>
									</tr>
									<tr>
										<td>
											<div class="checkbox"><label><input type="checkbox" value="in-ear"
														name="4_ld" required>In-ear headphones</label></div>
										</td>
										<td>
											<div class="checkbox"><label><input type="checkbox" value="over-ear"
														name="4_ld" required>Closed-back headphones</label></div>
										</td>
										<td>
											<div class="checkbox"><label><input type="checkbox" value="ex-ls"
														name="4_ld" required>External loudspeaker</label></div>
										</td>
										<td>
											<div class="checkbox"><label><input type="checkbox" value="ib-ls"
														name="4_ld" required>In-build loudspeaker</label></div>
										</td>
									</tr>

								</tbody>
							</table>
						</div>

					</fieldset>

					

					<fieldset class="qualificationFieldset"><label>5.&nbsp;Have you ever been directly involved in work
							connected with assessment of the performance of telephone systems, or related work such as
							speech coding?</label>
						<div class="radio">
							<label><input type="radio" name="7_working_area" value="Y" required="">Yes</label>
						</div>
						<div class="radio">
							<label><input type="radio" name="7_working_area" value="N">No</label>
						</div>
					</fieldset>

					<fieldset class="qualificationFieldset"><label>6.&nbsp; I belive, ...</label>
						<div class="radio">
							<label><input type="radio" name="8_hearing" value="normal" required="">I have a normal
								hearing ability.</label>
						</div>
						<div class="radio">
							<label><input type="radio" name="8_hearing" value="mid">I have difficulties keeping up with
								conversations, especially in noisy surroundings (mid hearing loss).</label>
						</div>
						<div class="radio">
							<label><input type="radio" name="8_hearing" value="moderate">I have difficulty keeping up
								with conversations when I am not using a hearing aid (moderate hearing loss).</label>
						</div>
						<div class="radio">
							<label><input type="radio" name="8_hearing" value="severe">I rely on lip-reading even when I
								am using hearing aids (severe or profound hearing loss). </label>
						</div>
					</fieldset>


					<div style="text-align: center;margin:30px;"> <img
							src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png"
							alt="attention"> </img> <b>Please wear your headphones now.</b></div>

					<fieldset class="qualificationFieldset"><label>7.&nbsp;Please adjust the volume level of your headset to a
							comfortable level so that you hear the following audio sample very well.</label>

						<p align="center"> <span class="baudio" id="volume"
								data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/signal_level.wav">&nbsp;</span>
						</p>

						<div class="alert alert-warning" role="alert">
							<b>NOTE:</b> After that, you are not allowed to change the volume anymore. Otherwise your
							response will be rejected.
						</div>

					</fieldset>

					<fieldset class="qualificationFieldset"><label>8.&nbsp;In each of the following tests, you hear
							combination of three digits (for example 1 5 3), spoken with noise in the background. Simply
							enter the three numbers that you have understood on the answer box below each audio file.
						</label>


						<div class="row" style="margin: 30px;">
							<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2">
								<div class="row" style="text-align:center;">
									<span class="baudio" id="n1" title="" data-src="{{cfg.num1_url}}">&nbsp;</span>
								</div>
								<input type="text" name="num1" required="" class="nospace" autocomplete="off">
							</div>

							<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd">
								<div class="row" style="text-align:center;">
									<span class="baudio" id="n2" title="" data-src="{{cfg.num2_url}}">&nbsp;</span>
								</div>
								<input type="text" name="num2" required="" class="nospace" autocomplete="off">
							</div>
							<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd">
								<div class="row" style="text-align:center;">
									<span class="baudio" id="n3" title="" data-src="{{cfg.num3_url}}">&nbsp;</span>
								</div>
								<input type="text" name="num3" required="" class="nospace" autocomplete="off">
							</div>
							<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd">
								<div class="row" style="text-align:center;">
									<span class="baudio" id="n4" title="" data-src="{{cfg.num4_url}}">&nbsp;</span>
								</div>
								<input type="text" name="num4" required="" class="nospace" autocomplete="off">
							</div>
							<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd">
								<div class="row" style="text-align:center;">
									<span class="baudio" id="n5" title="" data-src="{{cfg.num5_url}}">&nbsp;</span>
								</div>
								<input type="text" name="num5" required="" class="nospace" autocomplete="off">
							</div>
						</div>

					</fieldset>
					
					<fieldset class="qualificationFieldset"><label>9.&nbsp;  For this HIT, your hardware should be able to produce different audio details, and you should be able to hear them. Listen to the following samples. Each sample has two parts separated by a "beep". For each sample, please select if the quality of both parts is the same or different.				
					</label>
			
			
					<div class="row" style="margin: 30px;">
						<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd4">
							<div class="row" style="text-align:center;">
								<span class="baudio" id="comb_bw1" title="" data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/bw-test/d_g1_cmb.wav" >&nbsp;</span>
							</div>
							<div class="row" style="margin-left:20px" >
							<div class="radio">
								<label><input type="radio" name="comb_bw1" value="sq" required="">Same quality</label>
							</div>
							<div class="radio">
								<label><input type="radio" name="comb_bw1" value="dq">Different quality</label>								
							</div>
							</div>
						</div>
			
						<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd4" >
							<div class="row" style="text-align:center;">
								<span class="baudio" id="comb_bw2" title="" data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/bw-test/d_g2_cmb.wav">&nbsp;</span>
							</div>
							<div class="row" style="margin-left:20px" >
							<div class="radio">
								<label><input type="radio" name="comb_bw2" value="sq" required="">Same quality</label>
							</div>
							<div class="radio">
								<label><input type="radio" name="comb_bw2" value="dq">Different quality</label>
							</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd4">
							<div class="row" style="text-align:center;">
								<span class="baudio" id="comb_bw3" title="" data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/bw-test/d_g3_cmb.wav">&nbsp;</span>
							</div>
							<div class="row" style="margin-left:20px" >
								<div class="radio">
									<label><input type="radio" name="comb_bw3" value="sq" required="">Same quality</label>
								</div>
								<div class="radio">
									<label><input type="radio" name="comb_bw3" value="dq">Different quality</label>									
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd4">
							<div class="row" style="text-align:center;">
								<span class="baudio" id="comb_bw4" title="" data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/bw-test/d_g4_cmb.wav">&nbsp;</span>
							</div>
							<div class="row" style="margin-left:20px" >
								<div class="radio">
									<label><input type="radio" name="comb_bw4" value="sq" required="">Same quality</label>
								</div>
								<div class="radio">
									<label><input type="radio" name="comb_bw4" value="dq">Different quality</label>
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-2 col-lg-2 rnd4">
							<div class="row" style="text-align:center;">
								<span class="baudio" id="comb_bw5" title="" data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/bw-test/d_g5_cmb.wav">&nbsp;</span>
							</div>
							<div class="row" style="margin-left:20px" >
								<div class="radio">
									<label><input type="radio" name="comb_bw5" value="sq" required="">Same quality</label>
								</div>
								<div class="radio">
									<label><input type="radio" name="comb_bw5" value="dq">Different quality</label>
								</div>
							</div>
						</div>
					</div>
			
				</fieldset>

				</div>
			</div>
		</div>

	</div>
</section>


<!-- Setup -->
<section class="container disabled2_section" id="setup">
	<div class="panel panel-info">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#setup_panel" data-toggle="collapse">Setup (every <b class="setup_time"> a </b>
					minutes)</a>
			</h3>
		</div>
		<div class="panel-collapse collapse in" id="setup_panel">
			<div class="panel-body">

				<div style="text-align: center;margin:30px;"> <img
						src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png"
						alt="attention"> <b>Please wear your headphones now. You must <u>wear both earbuds</u>. </b>
				</div>

				<fieldset class="setupFieldset"><label>1.&nbsp;Please adjust the volume level of your headset to <b>a
							comfortable level</b> so that you hear the following audio sample very well.</label>

					<p align="center"> <span class="baudio" id="volume2"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/signal_level.wav">&nbsp;</span>
					</p>

					<div class="alert alert-danger" role="alert">
						<b>NOTE:</b> Missing this step can strongly affect quality of your answer.
					</div>

					<div class="alert alert-warning" role="alert">
						After adjusting the level, you are not allowed to change the volume anymore. Otherwise your
						response will be rejected.
					</div>
				</fieldset>


				<fieldset class="setupFieldset"><label>2.&nbsp; Please listen to the following audio file and type in
						the answer to the question: </label>

					<div align="center"> <span class="baudio" id="math1" data-src="${math}">&nbsp;</span> </div>


					<div align="center">Result: &nbsp; <input id="Math" name="Math" required="" size="10" type="text" /> </div>

				</fieldset>

				<div class="alert alert-info" role="alert">For the following <b>four questions</b>, please specify which
					sample has a better quality compared to the other one from your perspective.</div>


				<fieldset class="setupFieldset"><label>3.&nbsp;Which sample has a better quality compared to the other
						one? </label>

					<div class="row" style="margin-top:10px;">
						<div class="col-sm-4">
							<div align="right"> <span class="baudio" id="CMP1_A" title="Sample A"
									data-src="${CMP1_A}">&nbsp;</span> </div>
						</div>
						<div class="col-sm-4"></div>
						<div class="col-sm-4">
							<div align="left"> <span class="baudio" id="CMP1_B" title="Sample B"
									data-src="${CMP1_B}">&nbsp;</span> </div>
						</div>
					</div>

					<div class="row">
						<div class="col-sm-4"></div>
						<div class="col-sm-5">
							<div class="radio"><label><input type="radio" name="cmp1" required="" value="a">Quality of
									<b>Sample A</b> is better.</label></div>
							<div class="radio"><label><input type="radio" name="cmp1" required="" value="o">Difference
									is <b>not detectable</b>.</label></div>
							<div class="radio"><label><input type="radio" name="cmp1" required="" value="b">Quality of
									<b>Sample B</b> is better.</label></div>
						</div>
						<div class="col-sm-3"></div>
					</div>

				</fieldset>

				<fieldset class="setupFieldset"><label>4.&nbsp;Which sample has a better quality compared to the other
						one? </label>

					<div class="row" style="margin-top:10px;">
						<div class="col-sm-4">
							<div align="right"> <span class="baudio" id="CMP2_A" title="Sample A"
									data-src="${CMP2_A}">&nbsp;</span> </div>
						</div>
						<div class="col-sm-4"></div>
						<div class="col-sm-4">
							<div align="left"> <span class="baudio" id="CMP2_B" title="Sample B"
									data-src="${CMP2_B}">&nbsp;</span> </div>
						</div>
					</div>

					<div class="row">
						<div class="col-sm-4"></div>
						<div class="col-sm-5">
							<div class="radio"><label><input type="radio" name="cmp2" required="" value="a">Quality of
									<b>Sample A</b> is better.</label></div>
							<div class="radio"><label><input type="radio" name="cmp2" required="" value="o">Difference
									is <b>not detectable</b>.</label></div>
							<div class="radio"><label><input type="radio" name="cmp2" required="" value="b">Quality of
									<b>Sample B</b> is better.</label></div>
						</div>
						<div class="col-sm-3"></div>
					</div>

				</fieldset>
				<fieldset class="setupFieldset"><label>5.&nbsp;Which sample has a better quality compared to the other
						one? </label>

					<div class="row" style="margin-top:10px;">
						<div class="col-sm-4">
							<div align="right"> <span class="baudio" id="CMP3_A" title="Sample A"
									data-src="${CMP3_A}">&nbsp;</span> </div>
						</div>
						<div class="col-sm-4"></div>
						<div class="col-sm-4">
							<div align="left"> <span class="baudio" id="CMP3_B" title="Sample B"
									data-src="${CMP3_B}">&nbsp;</span> </div>
						</div>
					</div>

					<div class="row">
						<div class="col-sm-4"></div>
						<div class="col-sm-5">
							<div class="radio"><label><input type="radio" name="cmp3" required="" value="a">Quality of
									<b>Sample A</b> is better.</label></div>
							<div class="radio"><label><input type="radio" name="cmp3" required="" value="o">Difference
									is <b>not detectable</b>.</label></div>
							<div class="radio"><label><input type="radio" name="cmp3" required="" value="b">Quality of
									<b>Sample B</b> is better.</label></div>
						</div>
						<div class="col-sm-3"></div>
					</div>

				</fieldset>

				<fieldset class="setupFieldset"><label>6.&nbsp;Which sample has a better quality compared to the other
						one? </label>


					<div class="row" style="margin-top:10px;">
						<div class="col-sm-4">
							<div align="right"> <span class="baudio" id="CMP4_A" title="Sample A"
									data-src="${CMP4_A}">&nbsp;</span> </div>
						</div>
						<div class="col-sm-4"></div>
						<div class="col-sm-4">
							<div align="left"> <span class="baudio" id="CMP4_B" title="Sample B"
									data-src="${CMP4_B}">&nbsp;</span> </div>
						</div>
					</div>

					<div class="row">
						<div class="col-sm-4"></div>
						<div class="col-sm-5">
							<div class="radio"><label><input type="radio" name="cmp4" required="" value="a">Quality of
									<b>Sample A</b> is better.</label></div>
							<div class="radio"><label><input type="radio" name="cmp4" required="" value="o">Difference
									is <b>not detectable</b>.</label></div>
							<div class="radio"><label><input type="radio" name="cmp4" required="" value="b">Quality of
									<b>Sample B</b> is better.</label></div>
						</div>
						<div class="col-sm-3"></div>
					</div>

				</fieldset>

			</div>
		</div>
	</div>

</section>
<!-- Setup  ends-->

<!-- Device Check -->
<section class="container disabled2_section" id="device_check_section">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#device_check" data-toggle="collapse">Listening device check</a>
			</h3>
		</div>
		<div class="panel-collapse collapse in" id="device_check">
			<div class="panel-body">
				<b>Introduction</b>
				<p>We need to check your listening device. It is an automated test using your Web-browser functionality.
					Please click on <b>Start</b>.
					After that, you might see a popup message from your browser asking for allowance to use your
					microphone.
					Please click on <b>Allow</b> (on some of smartphones there will be no message). <u>We do not process
						or record any audio with your microphone</u>.
				<div class="center">
					<button type="button" class="btn btn-primary center" id="start_headset_check">Start</button>
					<div id="status"> </div>
				</div>
			</div>
		</div>

	</div>
</section>
<!-- Device Check ends-->

<!-- Instruction section-->
<section class="container disabled2_section" id="details_instruction">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#details_instruction" data-toggle="collapse">Detailed instruction (only once)</a>
			</h3>
		</div>
		<div class="panel-collapse collapse in" id="details_instruction_in">
			<div class="panel-body">
				<p style="background-color:Tomato;"> <b>NOTE: This instruction is new. Please carefully read and follow the instruction.</b></p>
				
				<p>In this experiment, you will be rating the speech quality of sound samples involving different speech impairments and background
					noise. Each trial will include <b>1 audio sample</b>, which should be rated on <b>7 scales</b>. First, you must listen to the clip 
					until the end, then start rating. In the meantime, the audio sample will be played in a loop until you finish rating all 7 scales (you can 
					only vote when the audio is playing). For each scale, you MUST ONLY focus on the specific aspect of the audio sample you are asked for on that scale.
					Besides the usual scale used for Signal and Overall Quality ratings, we also use <i>escriptive scales</i> for different quality characteristics. Here is an example for <b>Noisiness</b> characteristic:</p>

                    <img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/multi/scale.png" alt="scale" width ="600" style = "display: block; margin: auto;margin-bottom: 20px;">

                    Beside the main question about the characteristic, the scale has the following features:
					<ul>
						<li ><span style="background:#00A2E8">1. </span>Each scale has 5 levels.</li>
						<li ><span style="background:#ED1C24">2. </span>The poles of the scales are labeled with the antonym attributes, here: Not noisty  Noisy. To cast your vote, select a place on the scale. The closer to a pole, the more of that attribute you recognized.</li>
                        <li ><span style="background:#22B14C">3. </span>Below, more synonyms for each pole are given, to clarify them.</li>
						
					</ul>

					<p></p>Below are some (extreme) samples, a short description for each of them, and a picture from the continuous scales:</p>

				<h4>Scales and examples:</h4>				
				<!-- BAK-->
				<p> <b>1. Noisiness:</b></p>
				<p>"Noisiness" refers to how noisy a speech sample sounds. Noise can be present as <u>background noise </u>, circuit noise, and coding noise. It may be described with terms like "humming", "hissing" or "buzzy".</p>
				<div class="row">
					<div class="col-sm-3"></div> 
					<div class="col-sm-6">
						<p align="center"> <span class="baudio" id="ins2" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/sam2.wav">&nbsp;</span>							
						</p>
						<p align="center"> This sample is impaired with <b>strong</b> background noise.</p>
                        <img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/multi/noisiness.png" width ="100%">
					</div>
					 <div class="col-sm-3"></div>
				</div>

				<!-- loudness-->
				<p class="v-distance"> <b>2. Loudness:</b></p>
				<p>"Loudness" describes how optimal loudness level of the speech sample is, examples of <b>sub-optimal loudness</b> are: sample is <b>too quiet</b> or <b>unpleasantly loud</b>.</p>
				<div class="row">
					<div class="col-sm-2"></div> 
					<div class="col-sm-4"> 
						<p align="center"> <span class="baudio" id="ins3" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/sam3.wav">&nbsp;</span>
		
						</p>
						<p align="center"> This sample is too quiet. It is <b>sub-optimal</b> loudness.</p>

					</div> 
					<div class="col-sm-4">
						<p align="center"> <span class="baudio" id="ins4" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/sam4.wav">&nbsp;</span>							
						</p>
						<p align="center"> This sample is too loud. It is <b>sub-optimal</b> loudness.</p>
					</div>
					 <div class="col-sm-2"></div>

                     
				</div>
                <div class="row">
					<div class="col-sm-3"></div> 
					<div class="col-sm-6">
                        <img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/multi/o-loud.png" width ="100%">
                    </div> 
                </div> 


				<!-- Discontinuity-->
				<p class="v-distance"> <b>3. Discontinuity:</b></p>
				<p>A sample may sound "Choppy", "Shaky", "Ragged" or include "Pops and Clicks". They are referd as intruptions in speech signal or discontinuty in contrast to a speech which is steady and smooth.</p>
				<div class="row">
					<div class="col-sm-3"></div>  
					<div class="col-sm-6">
						<p align="center"> <span class="baudio" id="ins6" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/disc_0.5.wav">&nbsp;</span>							
						</p>
						<p align="center"> Discontinuity is strong and very annoying.</p>
                        <img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/multi/diss.png" width ="100%">
					</div>
						<div class="col-sm-3"></div>
				</div>

				<!-- Coloration -->
				<p class="v-distance"> <b>4. Coloration:</b></p>

				<p>Coloration can be understood as any changes to the sound that lead to the speech sample sounding <b>less "natural" or "normal"</b>. For example, the speech sample may sound "muffled", "distant", "thin" or like someone talking while plugging their nose.
					As it can have many forms, below are some samples concatenated in a single clip separated by a "beep" sound. All of them represent intense coloration.</p>
				</p>
				<div class="row">
					<div class="col-sm-3"></div> 					
					<div class="col-sm-6">
						<p align="center"> <span class="baudio" id="ins8" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/col_all.wav">&nbsp;</span>							
						</p>
				
                        <img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/multi/col.png" width ="100%">

						<!-- THDN  -->
						<p align="center">Another sample with high <b>Coloration</b> combined with other distortions like <b>Noisiness</b>.</p>
						<p align="center"> <span class="baudio" id="ins13" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/thdn.wav">&nbsp;</span>							
						</p>
					</div>
						<div class="col-sm-3"></div>
				</div>

				<!-- REVERBERATION  -->
				<p class="v-distance"> <b>5. Speech reverberation:</b></p>
				<p>Sometimes speech sounds reflected, similar to someone talking inside a tunnel/cave or from another corner of a large room.</p>
				<div class="row">
					<div class="col-sm-3"></div> 					
					<div class="col-sm-6">
						<p align="center"> <span class="baudio" id="ins10" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/sam10.wav">&nbsp;</span>							
						</p>
						<p align="center">This sample has moderate to high reverberation</p>
                        <img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/multi/rev.png" width ="100%">
					</div>
						<div class="col-sm-3"></div>
				</div>
				
				<!-- SIG -->
				<p class="v-distance"> <b>6. Entire Signal Quality:</b></p>
				<p>In most of the cases multiple of the above impairments can occur simultaneously. Entire signal quality refers to <b>all impairments that affect the speech signal only</b> and <b>excludes background noise</b>.</p>
				<div class="row">
					<div class="col-sm-2"></div> 
					<div class="col-sm-4"> 
						<p align="center"> <span class="baudio" id="ins11" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/sam11.wav">&nbsp;</span>
		
						</p>
						<p align="center">The speech signal is slightly distorted.</p>

					</div> 
					<div class="col-sm-4">
						<p align="center"> <span class="baudio" id="ins12" data-onfinished="inst_finished"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/multi/sam12.wav">&nbsp;</span>							
						</p>
						<p align="center">The speech signal is very distorted. There are also some background noise.</p>
					</div>
						<div class="col-sm-2"></div>
				</div>				

				<!-- Overall -->
				<p> <b>7. Overall Quality:</b></p>
				<p style="margin-bottom: 20px;">This refers to how well the sample you heard is suitable for purpose of everday speech communicaions considering all impairments.</p>

				<div class="alert alert-warning" role="alert">
					<h4>Attention:</h4>
					<p>You may hear an specific instruction in the speech sample starting by <b>"This is an interruption"</b> aksing you to select the scores
						showsing the <b>best</b> or the <b>worst</b> quality. In that case follow the instruction to show your attention, <u>otherwise your submision will be rejected</u>.</p>
						<p>  Scores showing the <b>best</b> quality are: <b>Not noisy, Optimal loudness, Continuous, Uncolored, No reverb, Not distorted, and Excellent quality. </b></p>
						<p>  Scores showing the <b>worst</b> quality are: <b>Noisy, Sub-optimal loudness, Discontinuous, Colored, High reverb, Very distorted, and Bad quality.</b></p>
					<p>
							<input type="checkbox" id="inst_check" name="instruction" value="understand" >
							<label for="inst_check">I confirm that I read the instruction and understand it.</label><br>
					</p>
				</div>	
				
				<div class="alert alert-warning" role="alert">
					<h4>Attention:</h4>
					<p>Next section will be activated, when you <b>listen to all the clips in this section fully and checked the you understand the instruction.</b>.</p>
				</div>

			</div>
		</div>
	</div>

</section>				
<!-- Instruction section ends-->

<!-- Training section, appears once a day
	<section class="container" id="training">
-->
<section class="container disabled_section disabled2_section" id="training">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#trainingS" data-toggle="collapse">Training (every <b class="training_time"> 0 </b>
					hour(s))</a>
			</h3>
		</div>
		<div class="panel-collapse collapse in" id="trainingS">
			<div class="panel-body">
				
				<p>The training section is identical to the Rating section, for some of the samples you might get a feedback:</p>
				
				<div>Please adjust the volume level of your headset to a <b>comfortable level</b> so that you hear the following audio sample very well. It is a very important step for this task and will directly influence your judgment.</label>
					<p align="center"> <span class="baudio" id="volume3"
							data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/signal_level.wav">&nbsp;</span>
					</p>
				</div>

				<p>In this experiment you will be rating the speech quality of sound samples involving <b>different speech impairments and also background
					noise</b>. Each trial will include <b>1 audio sample</b> which should be rated on <b>7 scales</b>. You should <b>let the audio sample play in loop until you are finished by all ratings</b>.</p>

				<p><b>Note:</b> The order of questions may change from one HIT to the other.</p>

				<p>Please provide your rating for the following <b class="question_number_training"> 0 </b> trials. Check out the "Detailes Instructions" for description of rating scales. 
					<b>Note</b> that the scale will be activated when the speech sample is played
					until the end. In case you hear an interruption message, please follow the instruction given in the
					message.</p>
				
					

				<!--<div id="traing_part2" class="disabled_section">-->
				<div id="traing_part2" >
					<!-- will be generated -->
					<ul class="nav nav-tabs" role="tablist" id="trainingTabs"> </ul>
					<!-- will be generated -->
					<div class="tab-content" id="nav-tabContent"> </div>


					<nav aria-label="..." id="navNextPreT">
						<ul class="pager">
							<li class="previous" id="showPreviousQuestionInTrainingSection" ><a href="#nav-tabContent"
									class="page-link" role="button"><span aria-hidden="true">&larr;</span>Previous trial</a>
							</li>
							<li class="next" id="showNextQuestionInTrainingSection"><a href="#nav-tabContent"
									class="page-link" id="next_button_training" role="button">Next trial<span aria-hidden="true">&rarr;</span></a>
							</li>
						</ul>
					</nav>
				</div>
				<div style="margin-top:0px;font-size:90%;text-align:center" id="training_end">Click <b>Next Trial</b> to answer all <b
						class="question_number_training"> 0 </b> trials.</div>
			</div>
		</div>
	</div>

</section>
<!-- Training section ends-->

<input id="tp_check" name="tp_check" type="hidden" value="-1" />
<input id="gq_check" name="gq_check" type="hidden" value="-1" />
<input id="errors" name="errors" type="hidden" value="" />
<input id="rdp_exist" name="rdp_exist" type="hidden" value="-1" />
<input id="bit_depth" name="bit_depth" type="hidden" value="-1" />
<input id="browser_info" name="browser_info" type="hidden" value="-1" maxlength="2000" />
<input id="webrtc_raw" name="webrtc_raw" type="hidden" value="-1" maxlength="2000" />
<input id="use_headset" name="use_headset" type="hidden" value="-1" />

<input id="time_page_hidden_sec" name="time_page_hidden_sec" type="hidden" value="0" />
<input id="any_parallel_session" name="any_parallel_session" type="hidden" value="false" />

<input id="log_script" name="log_script" type="hidden" value="" />

<input id="hash_s_js_all" name="hash_s_js_all" type="hidden" value="#hash_s_js_all#" />
<input id="hash_local_js_all" name="hash_local_js_all" type="hidden" value="" />
<input id="ttfb" name="ttfb" type="hidden" value="" />

<input id="p835_order" name="p835_order" type="hidden" value="bak_sig" />
<!--- Rating task -->

<section class="container disabled_section disabled2_section" id="rating_section">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">Ratings</h3>
		</div>
		<div class="panel-body">
			
			<p style="background-color:Tomato;"> <b>NOTE: New Instruction (April, 2023). This HIT is newly designed with updated instruction. Please carefully read and follow</b></p>
			<div class="row text-right" style="margin:10px"><button type="button" class="btn btn-success" id="show_detailed_instruction">Show the Detailed instruction again</button></div>	

			<div>Please adjust the volume level of your headset to a <b>comfortable level</b> so that you hear the following audio sample very well. It is a very important step for this task and will directly influence your judgment.</label>
				<p align="center"> <span class="baudio" id="volume4"
						data-src="https://audiosamplesp808.blob.core.windows.net/p808-assets/clips/signal_level.wav">&nbsp;</span>
				</p>
			</div>


			<p>In this experiment you will be rating the speech quality of sound samples involving <b>different speech impairments and also background
				noise</b>. Each trial will include <b>1 audio sample</b> which should be rated on <b>7 scales</b>. You should <b>let the audio sample play in loop until you are finished by all ratings</b>.</p>

			<p><b>Note:</b> The order of questions may change from one HIT to the other.</p>

			<p>Please provide your rating for the following <b class="question_number"> 0 </b> trials. Check out the "Detailes Instructions" for description of rating scales. 
				<b>Note</b> that the scale will be activated when the speech sample is played
				until the end. In case you hear an interruption message, please follow the instruction given in the
				message.</p>

			
			
			<!-- will be generated -->
			<ul class="nav nav-tabs" role="tablist" id="nav-tab-ul"> </ul>
			<!-- will be generated -->
			<div class="tab-content" id="nav-tabContent-rating"> </div>


			<nav aria-label="..." id="navNextPre"></nav>
				<ul class="pager">
					<li class="previous" id="prev-rating" ><a
							href="#nav-tabContent-rating" class="page-link" role="button"><span
								aria-hidden="true">&larr;</span>Previous trial</a></li>
					<li class="next" id="next-rating" ><a href="#nav-tabContent-rating"
							class="page-link" id="next_button_rating" role="button">Next trial<span aria-hidden="true">&rarr;</span></a></li>
				</ul>
			</nav>
			<div style="margin-top:0px;font-size:90%;text-align:center" id="rating_end">Click <b>Next trial</b> to answer all <b
					class="question_number">0</b> trials, then submit your response.</div>
		</div>
	</div>
</section>


<section class="container" id="thanks">
	<p>Thanks for your participation. Please perform more HITs from this group when they are available for you.</p>
	<p>Note: The submit button works only if you answer to all questions. Make sure to answer to all 7 questions in each
		trial. <a id="myLink" href="#" >Click here to see which
			questions in the "Rating" section are not answered?</a></p>
</section>

<section class="container" id="max_allowed_HITs_reached" hidden>
	<p>
	<h2>Well done! </h2> You performed the maximum number of HITs that you were allowed to.</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">
		<b>NOTE:</b> Performing more HITs
		than what is explained in the description is forbidden and leads to rejection of all of your submissions.
	</div>

</section>

<section class="container" id="qualification_rejected" hidden>
	<p>There is no assignments that match to your profile now. Please try it again in two-weeks time.
		We thank you for your participation.</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">
		<b>NOTE:</b> Any try to perform assignments and neglecting this message is forbidden and leads ro rejection of
		all of your submissions.
	</div>
</section>


<section class="container" id="gold_rejected" hidden>
	<p>The QA system recognized that you provided a wrong answer to multiple clips that their answers are known to us. 
		To avoid more of your submissions potentially get rejected, no more HITs from this job is available for you until we check them. 
	For any upcomming job, please carefully read the instruction and follow it. <u>The instruction can change from one job to the other.</u>
	</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">
		<b>NOTE:</b> Any try to perform assignments and neglecting this message is forbidden and leads ro rejection of
		all of your submissions. This is to avoid wasting your time.
	</div>
</section>